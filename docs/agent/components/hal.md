# HAL

## 概要

vSoCからHALをIPCで呼び出し、ハードウェアへアクセスする。HALは独自仕様であるが、サービスとしてWASIがHALのラッパーが提供される。

## 割り込みの仕組み

- 割り込みはフラグでインタープリタに通知する。
  - 割り込みフラグは「発生フラグ」と「割り込み要因フラグ」の2つで判定される。
  - バックエンドのドライバは割り込み時には割り込みフラグだけを立てる。
  - 割り込みフラグはvOffloderにMMIOされているため、wasmゲストからクリアすることができる。
- wasmゲストの割り込みハンドラは決め打ちの`intrupt_handler`関数で定義される。

## 想定されるバックエンド

- HALは標準入出力、タイマーを最低限の機能とする。
  - 標準Cライブラリ、標準C++ライブラリで実装する。
- 想定されるバックエンドドライバは下記の通りである。
  - ベアメタル
  - Zephyr

## 想定されるデバイス

下記のようなもののデバイスドライバを用意する。

- UART
- USB
- I2C
- SPI
- ADC

## HALのAPI

下記のコマンドを持つ。vSoCはIPCでHALのAPIにアクセスする。

- readコマンド
  - データを読み出す。
- writeコマンド
  - データを書き込む。
- seekコマンド
  - データを移動する。
  - デバイスによっては実装されない。
- ioctlコマンド
  - コマンドを実行する。
  - パラメータはIPCのKey-Value配列のため、voidポインタは用いない。




