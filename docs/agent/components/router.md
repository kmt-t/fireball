# IPCルータ

## ルータの通信プロトコル

1. IPCルータはvSoCとサブシステム間の通信に用いられる。
2. クライアントはサーバのIDをURIを用いてIPCルータに問い合わせる。
  - URIは`fireball://<subsystem_id>/<stream>`形式。
3. IPCルータが通信の許可、拒否の判定を行い、許可であればチャンネルIDを返却する。
4. クライアントはサーバのチャンネルIDを用いてco_cspで通信を行う。

## 通信の許可と拒否

- 各タスクはシステムグローバルで定義されたロールを持つ。
- サーバのロールに接続許可するクライアントのロールはグローバルに定義されている。
- グローバルなロールの定義はタスクから変更することはできない。

## メッセージ形式

- 一度に64ビットのKey-Value値を32個送ることができる。
- Key-Value値の内容は下記のとおりである。
  - 型およびスコープ (1 バイト)：上位 3 ビットで Scopeスコープ、下位 5 ビットでデータ型を表す。  
  - Key (3 バイト): スコープにより解釈が変わる。
  - Value (4 バイト): 32bitのデータ、ハンドル、または小さな即値。
- ソート済み配列インデックス
  - これはルータが自動的に付加する。
  - アルゴリズムは @docs/agent/patterns/stdlib.mdを参照すること。

## スコープ

- 機能的IPC
  - 値に対するキーとして機能する。  
- 辞書参照IPC
  - Keyは受信側が持つ辞書の文字列オフセットを示す。辞書にはNULL文字で連結された文字列が複数登録されている。

## データ型

- 符号付き整数: 32bit符号付き整数
- 符号なし整数: 32bit符号なし整数
- 単精度浮動小数点: 32bit浮動小数点
- 共有メモリID: メッセージで送ることができない大きなデータを渡すときはCOOSの共有メモリを使う。
  - 共有メモリには所有権が設定されているため、ルータが所有権を適切にサーバに渡す。

## IPCレジストリ

- IPCルータで接続する必要があるサブシステム、サービスは起動時にルータに自分のURIをレジストリに登録する。
- IPCルータのシャットダウン以外でレジストリのエントリが削除されることはない。レジストリは @docs/agent/patterns/stdlib.md に準じ、バンプアロケータを用いる。

## 辞書参照IPC

- 辞書はconstexprの関数で定義される。
- 辞書のオフセットもconstexprの関数で定義され、送受信双方でヘッダファイルで共有される。

## ロール

IPCルータの認可に使われるロールは下記のとおりである。

- vSoC
  - すべてのロールにアクセス可能
- HAL
  - vSoCと双方向に通信可能
- ロギング
  - すべてのロールから受信のみ可能
