# ランタイム

## 概要

wasmローダ、インタープリタとランタイムAPIで構成される。

- wasmランタイムはwasmゲストと一対一で実行される。
  - wasmゲストごとにプロセスが立ち上がるイメージである。
- wasmローダはwasm32バイナリ以外はロードする必要はない。
- インタープリタは実行状態を保持する実行コンテキストを持つ。

実装すべき最小セットの命令・ランタイムAPI仕様は、clangが出力するwasm32のバイナリ仕様から導出し、別途リスト化する。

## wasmローダ

wasmバイナリをパースする。

- ひとつのランタイムに複数のwasmモジュールがロードできる。
- ハイパーバイザ組み込みのwasmモジュールをサービス (@docs/agent/components/services.md)と呼ぶ。
- wasmバイナリはRAMに展開しない。ROM上でパースし、アクセスを効率化するための辞書を持つ。
- wasmバイナリの正当性を検証するベリファイアは簡易的なものにする。
- ローダで使用するメモリはモジュールが破棄されるまで解放されないのでバンプアロケータ (＠docs/agent/patterns/stdlib.md) でメモリを確保する。

## インタープリタ

インタープリタはwasmバイナリを実行する。

- goto文のラベルをテーブルとするスレッドインタープリタとする。
- デバッガが動いている場合はテーブルのジャンプ先を入れ替える。
- ジャンプ命令や関数呼び出し時にwasmゲストの連続実行時間が300usecを超えていた場合、co_yieldし、別のタスクに制御を渡す。
- ジャンプ命令や関数呼び出し時にHALから割り込みフラグが立てられていた場合、さらに割り込み要因をチェックし、wasmゲストの割り込み処理を行う。

## ランタイムAPI

ランタイムAPIはwasm命令の抽象化を行わない。ランタイムの性能のポイントはインタープリタではなく最適化されたランタイムAPIにある。

- ランタイムAPIの機能は原則としてwasm命令と一対一で対応する。
- インタープリタでは算術演算命令以外は実行コンテキストを引数にランタイムAPIを呼び出すだけである。
