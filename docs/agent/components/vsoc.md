# vSoC

## 構成要素

vSoCは下記の要素で構成されている。

- wasmランタイム
- vOffloader
- デバッガ
- JITコンパイラ

詳細仕様では

## wasmランタイム

### 概要

wasmローダ、インタープリタとランタイムAPIで構成される。

- wasmランタイムはwasmゲストと一対一で実行される。
  - wasmゲストごとにプロセスが立ち上がるイメージである。
- wasmローダはwasm32バイナリ以外はロードする必要はない。
- インタープリタは実行状態を保持する実行コンテキストを持つ。
- ランタイムAPIの機能はは原則としてwasm命令と一対一で対応する。
- インタープリタでは算術演算命令以外は実行コンテキストを引数にランタイムAPIを呼び出すだけである。

実装すべき最小セットの命令・ランタイムAPI仕様は、clangが出力するwasm32のバイナリ仕様から導出し、別途リスト化する。

### インタープリタ

インタープリタはwasmバイナリを実行する。

- ジャンプ命令や関数呼び出し時にwasmゲストの連続実行時間が300usecを超えていた場合、co_yieldし、別のタスクに制御を渡す。
- ジャンプ命令や関数呼び出し時にHALから割り込みフラグが立てられていた場合、さらに割り込み要因をチェックし、wasmゲストの割り込み処理を行う。

## vOffloader

wasmゲストから見てMMIOされたレジスタアクセスへの処理コンポーネントをvOffloaderと呼ぶ。

- vOffloaderはシステムコール、ネイティブライブラリ(openBLASなど)呼び出し、ハードウェアアクセスなどの機能を呼び出す。
- ハードウェアアクセスは原則としてIPCルータ経由でHALを呼び出す。
- 一部応答性が必要なGPIOなどはvOffoder内でターゲットの物理アドレスと対応したアドレス空間を用いてアクセスする。
  - コンフィグで許可された物理アドレスのみしかアクセスできないことに注意すること。

仕様の詳細は別ドキュメントで示す。

## デバッガ

wasmゲストをデバッグするためにRSP (GDB Remote Serial Protocol) をサポートする。

- x64環境では標準有出力とする。
- x64以外ではUARTを出力先とする。
- 省メモリ環境では実装できないためデバッガは無効化可能とする。

実装すべき最小セットのデバッガの仕様は、VSCodeのC/C++拡張機能が必要とするRSPの仕様から導出し、別途リスト化する。

## JITコンパイラ

- コピーアンドパッチのJITコンパイラ。
- JITコンパイラではインタープリタでは算術演算命令以外はインタープリタのコンテキストを引数にランタイムAPIを呼び出すだけである。
- デバッガやサービスによる命令フックが有効になっている場合は、JITコンパイラは追加でそれらを適用するコードを埋め込む。
- すべてのコードの実行するコードはJITコンパイルし、LRUで使ってないコンパイルキャッシュは破棄する。

仕様の詳細は別ドキュメントで示す。

