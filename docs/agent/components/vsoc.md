# vSoC

## 構成要素

vSoCは下記の要素で構成されている。

- ランタイム
- デバッガ
- JITコンパイラ
- vOffloader

## ランタイム

wasmローダ、インタープリタとランタイムAPIで構成される。

実装すべき最小セットのwasm命令の仕様は、clang++が出力するバイナリの仕様から導出し、別途リスト化する。

仕様の詳細は別ドキュメントで示す。

## デバッガ

wasmゲストをデバッグするためにRSP (GDB Remote Serial Protocol) をサポートする。

- x64環境では標準有出力とする。
- x64以外ではUARTを出力先とする。
- 省メモリ環境では実装できないためデバッガは無効化可能とする。

実装すべき最小セットのデバッガの仕様は、VSCodeのC/C++拡張機能が必要とするRSPの仕様から導出し、別途リスト化する。

## JITコンパイラ

- コピーアンドパッチのJITコンパイラ。
- JITコンパイラではインタープリタでは算術演算命令以外はインタープリタのコンテキストを引数にランタイムAPIを呼び出すだけである。
- デバッガやサービスによる命令フックが有効になっている場合は、JITコンパイラは追加でそれらを適用するコードを埋め込む。
- すべてのコードの実行するコードはJITコンパイルし、LRUで使ってないコンパイルキャッシュは破棄する。

仕様の詳細は別ドキュメントで示す。

## vOffloader

wasmゲストから見てMMIOされたレジスタアクセスへの処理コンポーネントをvOffloaderと呼ぶ。

- vOffloaderはシステムコール、ネイティブライブラリ(openBLASなど)呼び出し、ハードウェアアクセスなどの機能を呼び出す。
- ハードウェアアクセスは原則としてIPCルータ経由でHALを呼び出す。
- 一部応答性が必要なGPIOなどはvOffoder内でターゲットの物理アドレスと対応したアドレス空間を用いてアクセスする。
  - コンフィグで許可された物理アドレスのみしかアクセスできないことに注意すること。

仕様の詳細は別ドキュメントで示す。

