# 標準ライブラリの利用パターン

## 仕様を禁止された標準ライブラリ

下記の標準ライブラリは用いない。

- ファイルシステム関連
- std::vector
- std::map
- std::unordered_map
- std::thread
- 下記を除くランタイムのリンクが必要な標準C++ライブラリ。
  - コルーチン
  - スタックトレース
  - 標準入出力
  - 文字列ストリーム
  - std::chrono

詳細仕様では使用して良い標準C++ライブラリをリスト化すること。

## メモリアロケータ

- dlmallocのmspaceを用いる。
- mspaceの分割は @docs/agent/architecture/overview.md のヒープパーテーションの仕様に準じる。
- newおよびdelete演算子はオーバーロードしてmspaceに渡す。

## std::vectorの代替

- std::arrayの固定長配列を用いる。
- 部分配列をが必要な場合はstd::spanを用いる。

## std::map/std::unordered_mapの代替

std::mapのメモリ断片化の問題を避けるために下記の代替手法を用いてKey-Value配列で保存する。

- データの更新がなく想定される検索の回数が10回以上の場合
  - 事前に配列をKeyでソートしておき、二分検索する。
- 要素が100要素以下の場合
  - Key-Value配列のインデックス配列をソートし、検索時はインデックス配列を用いて二分検索する。

検索には`std::lower_bound`を用いる。

## バンプアロケータ

メモリに対し、コンポーネントの終了時以外に解放が必要がない場合バンプアロケータからメモリを確保する。
