# 要件リスト

## 何をつくるのか

- wasm32ゲストを仮想化するハイパーバイザである。
- 小規模な組み込み向けである。

## 開発環境

- コンパイラ
  - clang
  - C99
  - C++23
  - libstdc++

## ターゲット

- ターゲットのMCUのアーキテクチャは下記のとおりである。
  - Cortex-M33
  - RISC-V/32
  - Linux
- 最小MCUターゲットはCortex-M33/RAM64KB/ROM128KBである。
- POSIX上で動くことは必須だが、その機能サブセットとして標準Cライブラリ、標準C++ライブラリ以外のライブラリは用いない。

# OS

- シングルスレッド動作とし、グリーンスレッド（コルーチン）で並列処理を行う。
- コルーチンを用いた協調型OSであるCOOSを独自設計する。
- COOSの並列処理の同期はホーアCSPで行う。
- メモリ管理は独自のメモリ管理とする。

## vSoC

- vSoCはwasm32のランタイムを持つ。浮動小数点の機能は実装しない。
- vSoCはvOffloaderというMMIOを持つ。
- vSoCで複数のゲストを実行できるようにする。マルチコア対応はコアごとにハイパーバイザをアフィニティする構成。
  - ハイパーバイザ間のデバイスドライバの排他処理はデバイスドライバ層で行う。
- HALから割り込みフラグを立て、インタープリタから監視する。ゲストのコンテキストスイッチ時にvSoCがフラグをチェックする。
- JITコンパイラの基本方針はレイテンシの最小化である。テンプレートをヒープに展開しパッチを当てる方式。基本的な算術演算を除き、vSoCのランタイムAPI呼び出しをコンパイルするのみ。

## システムコール

- システムコールは独自のシステムコールとする。
- システムコールはIPCで行われる。
- IPCの経路はIPCルータが管理する。

## HAL

- HALは独自仕様とする。
- プラグインとしてWASIラッパーを持つ。
- HALのバックエンドのドライバはベアメタル、Zephyr、Linuxを想定する。
- プロセス間通信はCSPを用いたIPCとする。

## 設定

- ヘッダファイル形式のコンフィグファイルを定義しその中のマクロで容量などは固定する。
- ヘッダファイル形式のコンフィグファイルを定義しその中のマクロでヒープサイズなどを固定する。
