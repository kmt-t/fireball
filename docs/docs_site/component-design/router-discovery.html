<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>router-discovery</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">router-discovery</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#fireball-ipc-ルータ-uri-ベース-サービス発見とアクセス制御"
id="toc-fireball-ipc-ルータ-uri-ベース-サービス発見とアクセス制御">Fireball
IPC ルータ: URI ベース サービス発見とアクセス制御</a>
<ul>
<li><a href="#概要" id="toc-概要">概要</a></li>
<li><a href="#設計原則" id="toc-設計原則">1. 設計原則</a>
<ul>
<li><a href="#つの重要概念" id="toc-つの重要概念">1.1 3
つの重要概念</a></li>
<li><a href="#設計目標" id="toc-設計目標">1.2 設計目標</a></li>
</ul></li>
<li><a href="#uri-スキーム設計" id="toc-uri-スキーム設計">2. URI
スキーム設計</a>
<ul>
<li><a href="#uri-フォーマット" id="toc-uri-フォーマット">2.1 URI
フォーマット</a></li>
</ul></li>
<li><a href="#ルータ-データ構造" id="toc-ルータ-データ構造">3. ルータ
データ構造</a>
<ul>
<li><a href="#サービス-レジストリ" id="toc-サービス-レジストリ">3.1
サービス レジストリ</a></li>
<li><a href="#アクセス-ポリシー構造" id="toc-アクセス-ポリシー構造">3.2
アクセス ポリシー構造</a></li>
</ul></li>
<li><a href="#クエリとルート解決" id="toc-クエリとルート解決">4.
クエリとルート解決</a>
<ul>
<li><a href="#クエリ-フロー" id="toc-クエリ-フロー">4.1 クエリ
フロー</a></li>
<li><a href="#実装例" id="toc-実装例">4.2 実装例</a></li>
<li><a href="#route-id-coroutine-id" id="toc-route-id-coroutine-id">4.3
Route ID = Coroutine ID</a></li>
</ul></li>
<li><a href="#権限モデル例" id="toc-権限モデル例">5. 権限モデル例</a>
<ul>
<li><a href="#例-1-gpio-出力---登録者のみアクセス"
id="toc-例-1-gpio-出力---登録者のみアクセス">5.1 例 1: GPIO 出力 -
登録者のみアクセス</a></li>
<li><a href="#例-2-logger-サービス---全員アクセス可能"
id="toc-例-2-logger-サービス---全員アクセス可能">5.2 例 2: Logger
サービス - 全員アクセス可能</a></li>
<li><a href="#例-3-高権限-dsp---委譲制御"
id="toc-例-3-高権限-dsp---委譲制御">5.3 例 3: 高権限 DSP -
委譲制御</a></li>
</ul></li>
<li><a href="#ライフサイクル" id="toc-ライフサイクル">6.
ライフサイクル</a>
<ul>
<li><a href="#サービス登録" id="toc-サービス登録">6.1
サービス登録</a></li>
<li><a href="#サービス-使用" id="toc-サービス-使用">6.2 サービス
使用</a></li>
</ul></li>
<li><a href="#パフォーマンス特性" id="toc-パフォーマンス特性">7.
パフォーマンス特性</a>
<ul>
<li><a href="#ルックアップ-パフォーマンス"
id="toc-ルックアップ-パフォーマンス">7.1 ルックアップ
パフォーマンス</a></li>
<li><a href="#メモリ-オーバーヘッド" id="toc-メモリ-オーバーヘッド">7.2
メモリ オーバーヘッド</a></li>
</ul></li>
<li><a href="#原子性と-toctou-防止" id="toc-原子性と-toctou-防止">8.
原子性と TOCTOU 防止</a>
<ul>
<li><a href="#toctou-対策" id="toc-toctou-対策">8.1 TOCTOU 対策</a></li>
</ul></li>
<li><a href="#実装チェックリスト" id="toc-実装チェックリスト">9.
実装チェックリスト</a></li>
<li><a href="#まとめ" id="toc-まとめ">まとめ</a></li>
</ul></li>
</ul>
</nav>
<h1
id="fireball-ipc-ルータ-uri-ベース-サービス発見とアクセス制御">Fireball
IPC ルータ: URI ベース サービス発見とアクセス制御</h1>
<p><strong>Version:</strong> 0.1.0 <strong>Date:</strong> 2025-11-30
<strong>Author:</strong> Takuya Matsunaga</p>
<hr />
<h2 id="概要">概要</h2>
<p>Fireball IPC ルータは <strong>URI ベースのサービス発見</strong> と
<strong>権限チェック付きルート解決</strong> を提供します。クライアントが
URI 経由でサービスリクエストを行う際、ルータはそれを Route
ID（コルーチン ID）に解決し、同時にアクセス権限をチェックします。</p>
<p><strong>主要機能：</strong> URI
ベースサービス発見、権限チェック、O(log N)
ルックアップ、原子的クエリ</p>
<hr />
<h2 id="設計原則">1. 設計原則</h2>
<h3 id="つの重要概念">1.1 3 つの重要概念</h3>
<table>
<thead>
<tr class="header">
<th>概念</th>
<th>定義</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>URI</strong></td>
<td>サービス識別子（人間可読）</td>
<td><code>"service://dsp/fft/0"</code></td>
</tr>
<tr class="even">
<td><strong>Route ID</strong></td>
<td>サービス実行コルーチン ID</td>
<td><code>42</code>（コルーチン #42）</td>
</tr>
<tr class="odd">
<td><strong>Permission</strong></td>
<td>アクセス制御決定</td>
<td><code>ALLOW</code>、<code>DENY</code>、<code>DELEGATED</code></td>
</tr>
</tbody>
</table>
<h3 id="設計目標">1.2 設計目標</h3>
<ol type="1">
<li><strong>シンプル</strong>: 単一クエリでRoute ID と
アクセス決定を返却</li>
<li><strong>効率</strong>: O(log N) ルックアップ（線形探索なし）</li>
<li><strong>セキュリティ</strong>:
呼び出し元コンテキストをクエリ毎に検証</li>
<li><strong>原子性</strong>:
TOCTOU（Time-Of-Check-Time-Of-Use）レース回避</li>
</ol>
<hr />
<h2 id="uri-スキーム設計">2. URI スキーム設計</h2>
<h3 id="uri-フォーマット">2.1 URI フォーマット</h3>
<pre><code>service://[namespace]/[component]/[instance]</code></pre>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 35%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr class="header">
<th>部分</th>
<th>意味</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>service://</code></td>
<td>プロトコル固定</td>
<td>固定</td>
</tr>
<tr class="even">
<td><code>namespace</code></td>
<td>サービスカテゴリ</td>
<td><code>gpio</code>、<code>uart</code>、<code>dsp</code>、<code>sensor</code>、<code>app</code></td>
</tr>
<tr class="odd">
<td><code>component</code></td>
<td>論理グループ（オプション）</td>
<td><code>output</code>、<code>adc</code>、<code>channel</code></td>
</tr>
<tr class="even">
<td><code>instance</code></td>
<td>特定インスタンス番号</td>
<td><code>0</code>、<code>5</code>、<code>all</code></td>
</tr>
</tbody>
</table>
<p><strong>例：</strong></p>
<table>
<thead>
<tr class="header">
<th>URI</th>
<th>サービス</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>service://gpio/output/5</code></td>
<td>GPIO 出力ドライバ</td>
<td>GPIO ピン 5 出力</td>
</tr>
<tr class="even">
<td><code>service://gpio/input/3</code></td>
<td>GPIO 入力ドライバ</td>
<td>GPIO ピン 3 入力</td>
</tr>
<tr class="odd">
<td><code>service://uart/tx/0</code></td>
<td>UART 送信</td>
<td>UART デバイス 0 TX</td>
</tr>
<tr class="even">
<td><code>service://dsp/fft/0</code></td>
<td>FFT アクセラレータ</td>
<td>FFT プロセッサ #0</td>
</tr>
<tr class="odd">
<td><code>service://app/led_controller</code></td>
<td>ユーザー アプリ</td>
<td>LED 制御アプリ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ルータ-データ構造">3. ルータ データ構造</h2>
<h3 id="サービス-レジストリ">3.1 サービス レジストリ</h3>
<p>ルータは <strong>ソート済みバイナリサーチツリー</strong>
でサービス登録を管理：</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> service_entry <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>string uri<span class="op">;</span>              <span class="co">// サービス URI（ソート キー）</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> route_id<span class="op">;</span>            <span class="co">// サービス実行コルーチン ID</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> owner_coroutine<span class="op">;</span>     <span class="co">// 登録したコルーチン</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  access_policy<span class="op">*</span> policy<span class="op">;</span>        <span class="co">// アクセス制御ルール</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> registration_time<span class="op">;</span>   <span class="co">// 登録時刻</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> router_registry <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a> <span class="kw">private</span><span class="op">:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>map<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">,</span> service_entry<span class="op">&gt;</span> <span class="va">services_</span><span class="op">;</span>  <span class="co">// URI でソート</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> query_result <span class="op">{</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status<span class="op">;</span>           <span class="co">// 0=成功、-1=未検出、-2=アクセス拒否</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> route_id<span class="op">;</span>    <span class="co">// サービス コルーチン ID</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    access_policy<span class="op">*</span> policy<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  query_result query<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> uri<span class="op">,</span> <span class="dt">uint32_t</span> caller_coro_id<span class="op">);</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> register_service<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> uri<span class="op">,</span> <span class="dt">uint32_t</span> route_id<span class="op">,</span> access_policy<span class="op">*</span> policy<span class="op">);</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> unregister_service<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> uri<span class="op">);</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="アクセス-ポリシー構造">3.2 アクセス ポリシー構造</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> access_decision <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  ALLOW <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  DENY <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  DELEGATED <span class="op">=</span> <span class="dv">2</span><span class="op">,</span>        <span class="co">// スケジューラに判定委譲</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> access_policy <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">enum</span> <span class="dt">rule_type</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    RULE_ANY <span class="op">=</span> <span class="dv">0</span><span class="op">,</span>            <span class="co">// すべて許可</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    RULE_SPECIFIC_CORO <span class="op">=</span> <span class="dv">1</span><span class="op">,</span>  <span class="co">// 特定コルーチンのみ</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    RULE_SPECIFIC_APP <span class="op">=</span> <span class="dv">2</span><span class="op">,</span>   <span class="co">// 特定アプリのみ</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    RULE_OWNER_ONLY <span class="op">=</span> <span class="dv">3</span><span class="op">,</span>     <span class="co">// 登録者のみ</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">rule_type</span> type<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> value<span class="op">;</span>  <span class="co">// Coroutine ID または App ID</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> allow_delegation<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  access_decision check<span class="op">(</span><span class="dt">uint32_t</span> caller_coro_id<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<hr />
<h2 id="クエリとルート解決">4. クエリとルート解決</h2>
<h3 id="クエリ-フロー">4.1 クエリ フロー</h3>
<pre><code>クライアント コルーチン（例：coro #10）
    │
    ├─ router.query(&quot;service://gpio/output/5&quot;, caller_id=10) 呼び出し
    │
    └─ Router.query():
         ├─ バイナリサーチツリーで URI 検索
         │  └─ 見出し: route_id=35、policy=...
         │
         ├─ access_policy.check(caller_id=10)
         │  ├─ RULE_ANY: 許可
         │  ├─ RULE_SPECIFIC_CORO: caller_id == rule.value か確認
         │  ├─ RULE_OWNER_ONLY: caller_id == 登録者 か確認
         │  └─ DELEGATED: スケジューラに判定委譲
         │
         └─ 返却: {status=0, route_id=35, policy=...}</code></pre>
<h3 id="実装例">4.2 実装例</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>query_result router_registry<span class="op">::</span>query<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> uri<span class="op">,</span> <span class="dt">uint32_t</span> caller_coro_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ステップ 1: バイナリサーチ検索</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> it <span class="op">=</span> <span class="va">services_</span><span class="op">.</span>find<span class="op">(</span>uri<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>it <span class="op">==</span> <span class="va">services_</span><span class="op">.</span>end<span class="op">())</span> <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> route_id<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> policy<span class="op">:</span> <span class="kw">nullptr</span><span class="op">};</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  service_entry<span class="op">&amp;</span> entry <span class="op">=</span> it<span class="op">-&gt;</span>second<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ステップ 2: アクセス権限チェック</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  access_decision decision <span class="op">=</span> entry<span class="op">.</span>policy<span class="op">-&gt;</span>check<span class="op">(</span>caller_coro_id<span class="op">);</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>decision<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> ALLOW<span class="op">:</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> route_id<span class="op">:</span> entry<span class="op">.</span>route_id<span class="op">,</span> policy<span class="op">:</span> entry<span class="op">.</span>policy<span class="op">};</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> DENY<span class="op">:</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">logger_</span><span class="op">-&gt;</span>log_access_denied<span class="op">(</span>uri<span class="op">,</span> caller_coro_id<span class="op">);</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span> route_id<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> policy<span class="op">:</span> <span class="kw">nullptr</span><span class="op">};</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> DELEGATED<span class="op">:</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint32_t</span> parent_decision <span class="op">=</span> <span class="va">co_sched_</span><span class="op">-&gt;</span>ask_parent_permission<span class="op">(</span>caller_coro_id<span class="op">,</span> uri<span class="op">);</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>parent_decision<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> route_id<span class="op">:</span> entry<span class="op">.</span>route_id<span class="op">,</span> policy<span class="op">:</span> entry<span class="op">.</span>policy<span class="op">};</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span> route_id<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> policy<span class="op">:</span> <span class="kw">nullptr</span><span class="op">};</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="route-id-coroutine-id">4.3 Route ID = Coroutine ID</h3>
<p><strong>重要：</strong> Fireball ではサービス
<strong>がコルーチン</strong>。URI クエリで得られるのはそのコルーチン
ID。</p>
<pre><code>サービス登録:
  coro #35: GPIO 出力サービス実行
  → register(&quot;service://gpio/output/5&quot;, route_id=35)

サービス使用:
  coro #10: サービスリクエスト
  → router.query(&quot;service://gpio/output/5&quot;, caller_id=10)
  → 返却: route_id=35
  → coro #10 が coro #35 に CSP チャネル経由でメッセージ送信</code></pre>
<hr />
<h2 id="権限モデル例">5. 権限モデル例</h2>
<h3 id="例-1-gpio-出力---登録者のみアクセス">5.1 例 1: GPIO 出力 -
登録者のみアクセス</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>access_policy gpio_policy<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gpio_policy<span class="op">.</span>type <span class="op">=</span> RULE_OWNER_ONLY<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>gpio_policy<span class="op">.</span>allow_delegation <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span>register_service<span class="op">(</span><span class="st">&quot;service://gpio/output/5&quot;</span><span class="op">,</span> gpio_output_coro_id<span class="op">,</span> <span class="op">&amp;</span>gpio_policy<span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">// アプリ コルーチン（coro #10）からのクエリ</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> result <span class="op">=</span> router<span class="op">.</span>query<span class="op">(</span><span class="st">&quot;service://gpio/output/5&quot;</span><span class="op">,</span> caller_id<span class="op">=</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 結果: status=0（クエリは許可、書き込みはサービス内で権限確認可能）</span></span></code></pre></div>
<h3 id="例-2-logger-サービス---全員アクセス可能">5.2 例 2: Logger
サービス - 全員アクセス可能</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>access_policy logger_policy<span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>logger_policy<span class="op">.</span>type <span class="op">=</span> RULE_ANY<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span>register_service<span class="op">(</span><span class="st">&quot;service://logger&quot;</span><span class="op">,</span> logger_coro_id<span class="op">,</span> <span class="op">&amp;</span>logger_policy<span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">// 任意のコルーチンからのクエリが許可</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> result <span class="op">=</span> router<span class="op">.</span>query<span class="op">(</span><span class="st">&quot;service://logger&quot;</span><span class="op">,</span> caller_id<span class="op">=</span>any<span class="op">);</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 結果: status=0（常に許可）</span></span></code></pre></div>
<h3 id="例-3-高権限-dsp---委譲制御">5.3 例 3: 高権限 DSP - 委譲制御</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>access_policy dsp_policy<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dsp_policy<span class="op">.</span>type <span class="op">=</span> RULE_DELEGATED<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dsp_policy<span class="op">.</span>allow_delegation <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span>register_service<span class="op">(</span><span class="st">&quot;service://dsp/fft/0&quot;</span><span class="op">,</span> dsp_coro_id<span class="op">,</span> <span class="op">&amp;</span>dsp_policy<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ルータが親（スケジューラ）に判定を委譲</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> result <span class="op">=</span> router<span class="op">.</span>query<span class="op">(</span><span class="st">&quot;service://dsp/fft/0&quot;</span><span class="op">,</span> caller_id<span class="op">=</span>app_coro<span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ルータ: co_sched_-&gt;ask_parent_permission(app_coro, &quot;service://dsp/fft/0&quot;)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">// スケジューラが app_coro の権限レベルを確認、status=0 または status=-2 返却</span></span></code></pre></div>
<hr />
<h2 id="ライフサイクル">6. ライフサイクル</h2>
<h3 id="サービス登録">6.1 サービス登録</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> gpio_output_service_main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ハードウェア 初期化</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> my_coro_id <span class="op">=</span> <span class="va">co_sched_</span><span class="op">-&gt;</span>current_coro_id<span class="op">();</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  access_policy policy <span class="op">=</span> create_gpio_policy<span class="op">();</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> status <span class="op">=</span> <span class="va">router_</span><span class="op">-&gt;</span>register_service<span class="op">(</span><span class="st">&quot;service://gpio/output/5&quot;</span><span class="op">,</span> my_coro_id<span class="op">,</span> <span class="op">&amp;</span>policy<span class="op">);</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">logger_</span><span class="op">-&gt;</span>log_error<span class="op">(</span><span class="st">&quot;GPIO サービス登録失敗&quot;</span><span class="op">);</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// サービス起動</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> msg <span class="op">=</span> <span class="va">my_channel_</span><span class="op">-&gt;</span>receive<span class="op">();</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    handle_gpio_request<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="サービス-使用">6.2 サービス 使用</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> app_main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ルータでサービス クエリ</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> result <span class="op">=</span> <span class="va">router_</span><span class="op">-&gt;</span>query<span class="op">(</span><span class="st">&quot;service://gpio/output/5&quot;</span><span class="op">,</span> my_coro_id<span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>status <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>status <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="va">logger_</span><span class="op">-&gt;</span>log<span class="op">(</span><span class="st">&quot;サービス未検出&quot;</span><span class="op">);</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>status <span class="op">==</span> <span class="op">-</span><span class="dv">2</span><span class="op">)</span> <span class="va">logger_</span><span class="op">-&gt;</span>log<span class="op">(</span><span class="st">&quot;アクセス拒否&quot;</span><span class="op">);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// result.route_id = 35（GPIO サービス コルーチン）</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// メッセージ送信</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ipc_record_t</span> msg<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  msg<span class="op">.</span>key_id <span class="op">=</span> result<span class="op">.</span>route_id<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  msg<span class="op">.</span>value <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="va">router_</span><span class="op">-&gt;</span>route<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="パフォーマンス特性">7. パフォーマンス特性</h2>
<h3 id="ルックアップ-パフォーマンス">7.1 ルックアップ
パフォーマンス</h3>
<table>
<thead>
<tr class="header">
<th>操作</th>
<th>計算量</th>
<th>典型時間</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>クエリ（完全一致）</strong></td>
<td>O(log N)</td>
<td>&lt;10 μs（N=100）</td>
</tr>
<tr class="even">
<td><strong>バイナリサーチ</strong></td>
<td>O(log N)</td>
<td>&lt;5 μs</td>
</tr>
<tr class="odd">
<td><strong>アクセス チェック</strong></td>
<td>O(1)</td>
<td>&lt;1 μs</td>
</tr>
<tr class="even">
<td><strong>合計クエリ</strong></td>
<td>O(log N)</td>
<td>&lt;15 μs</td>
</tr>
</tbody>
</table>
<h3 id="メモリ-オーバーヘッド">7.2 メモリ オーバーヘッド</h3>
<table>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>サイズ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>サービス エントリ</td>
<td>~256B</td>
<td>URI 文字列 + メタデータ</td>
</tr>
<tr class="even">
<td>ツリー構造</td>
<td>32B × ノード数</td>
<td>ポインタ、比較情報</td>
</tr>
<tr class="odd">
<td>ハッシュテーブル（Route ID）</td>
<td>64B × エントリ</td>
<td>逆ルックアップ用</td>
</tr>
<tr class="even">
<td><strong>典型値（100 サービス）</strong></td>
<td><strong>~26KB</strong></td>
<td>Phase 2 予算内</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="原子性と-toctou-防止">8. 原子性と TOCTOU 防止</h2>
<h3 id="toctou-対策">8.1 TOCTOU 対策</h3>
<p>クエリ操作は
<strong>原子的</strong>：サービスはルックアップと権限チェック間で削除されない。</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>query_result router_registry<span class="op">::</span>query<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> uri<span class="op">,</span> <span class="dt">uint32_t</span> caller_coro_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> lock <span class="op">=</span> <span class="va">services_mutex_</span><span class="op">.</span>read_lock<span class="op">();</span>  <span class="co">// 読み取りロック取得</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> it <span class="op">=</span> <span class="va">services_</span><span class="op">.</span>find<span class="op">(</span>uri<span class="op">);</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>it <span class="op">==</span> <span class="va">services_</span><span class="op">.</span>end<span class="op">())</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">{</span>status<span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="op">...};</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  service_entry<span class="op">&amp;</span> entry <span class="op">=</span> it<span class="op">-&gt;</span>second<span class="op">;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  access_decision decision <span class="op">=</span> entry<span class="op">.</span>policy<span class="op">-&gt;</span>check<span class="op">(</span>caller_coro_id<span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ロック保持中に両操作実行</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ロック解放</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="実装チェックリスト">9. 実装チェックリスト</h2>
<ul class="task-list">
<li><label><input type="checkbox" />サービス URI
フォーマット定義と検証</label></li>
<li><label><input type="checkbox" />バイナリサーチツリー サービス
レジストリ実装</label></li>
<li><label><input type="checkbox" />access_policy::check()
ロジック実装</label></li>
<li><label><input type="checkbox" />query()
権限チェック付き実装</label></li>
<li><label><input type="checkbox" />読み書き ロック
スレッド安全性実装</label></li>
<li><label><input
type="checkbox" />委譲メカニズム実装（スケジューラに要求）</label></li>
<li><label><input type="checkbox" />サービス登録 API</label></li>
<li><label><input type="checkbox" />サービス削除 API</label></li>
<li><label><input type="checkbox" />プレフィックス マッチング
サービス発見</label></li>
<li><label><input type="checkbox" />アクセス決定監査ログ</label></li>
<li><label><input type="checkbox" />クエリ ロジック
ユニットテスト</label></li>
<li><label><input type="checkbox" />マルチサービス
統合テスト</label></li>
<li><label><input type="checkbox" />O(log N) ルックアップ
パフォーマンス検証</label></li>
<li><label><input type="checkbox" />監視
API（サービス一覧）</label></li>
</ul>
<hr />
<h2 id="まとめ">まとめ</h2>
<p>Fireball IPC ルータは <strong>URI
ベースのサービス発見と統合アクセス制御</strong>
を提供。重要イノベーション：</p>
<ol type="1">
<li><strong>Route ID = Coroutine ID</strong>:
直接マッピング、ルーティング簡潔化</li>
<li><strong>バイナリサーチ ルックアップ</strong>: O(log N) で 100+
サービス高速検索</li>
<li><strong>原子的クエリ</strong>:
ルックアップと権限チェックが同時実行、TOCTOU レース回避</li>
<li><strong>柔軟権限モデル</strong>:
複数権限パターン対応（所有者のみ、全員、委譲）</li>
<li><strong>階層 URI</strong>: サービスを namespace/component/instance
で組織化</li>
</ol>
<p>リソース制約組み込みシステムで<strong>安全で効率的なサービス発見</strong>を実現。</p>
</body>
</html>
