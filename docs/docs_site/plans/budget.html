<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>budget</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">budget</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#fireball-performance-optimization"
id="toc-fireball-performance-optimization">Fireball Performance &amp;
Optimization</a>
<ul>
<li><a href="#overview" id="toc-overview">Overview</a></li>
<li><a href="#メモリ予算memory-budget"
id="toc-メモリ予算memory-budget">1. メモリ予算（Memory Budget）</a>
<ul>
<li><a href="#rom-予算rom-budget" id="toc-rom-予算rom-budget">1.1 ROM
予算（ROM Budget）</a></li>
<li><a href="#rom-見積の現実と検証計画stm32f401ベース"
id="toc-rom-見積の現実と検証計画stm32f401ベース">1.1.1 ROM
見積の現実と検証計画（STM32F401ベース）</a></li>
<li><a href="#ram-予算ram-budget---stm32f401ベース"
id="toc-ram-予算ram-budget---stm32f401ベース">1.2 RAM 予算（RAM Budget -
STM32F401ベース）</a></li>
<li><a href="#メモリレイアウト例memory-layout-example"
id="toc-メモリレイアウト例memory-layout-example">1.3
メモリレイアウト例（Memory Layout Example）</a></li>
</ul></li>
<li><a href="#コンテキストスイッチコストcontext-switch-cost"
id="toc-コンテキストスイッチコストcontext-switch-cost">2.
コンテキストスイッチコスト（Context Switch Cost）</a>
<ul>
<li><a href="#測定measurements" id="toc-測定measurements">2.1
測定（Measurements）</a></li>
<li><a href="#最適化戦略optimization-strategy"
id="toc-最適化戦略optimization-strategy">2.2 最適化戦略（Optimization
Strategy）</a></li>
</ul></li>
<li><a href="#チャネル操作コストchannel-operation-cost"
id="toc-チャネル操作コストchannel-operation-cost">3.
チャネル操作コスト（Channel Operation Cost）</a>
<ul>
<li><a href="#基本操作basic-operations"
id="toc-基本操作basic-operations">3.1 基本操作（Basic
Operations）</a></li>
<li><a href="#move-セマンティクスの効果move-semantics-impact"
id="toc-move-セマンティクスの効果move-semantics-impact">3.2 move
セマンティクスの効果（Move Semantics Impact）</a></li>
</ul></li>
<li><a href="#メモリ隔離のパフォーマンスmemory-isolation-performance"
id="toc-メモリ隔離のパフォーマンスmemory-isolation-performance">4.
メモリ隔離のパフォーマンス（Memory Isolation Performance）</a>
<ul>
<li><a href="#dlmalloc-mspace-オーバーヘッド"
id="toc-dlmalloc-mspace-オーバーヘッド">4.1 dlmalloc mspace
オーバーヘッド</a></li>
<li><a href="#メモリ枯渇時の動作memory-exhaustion-behavior"
id="toc-メモリ枯渇時の動作memory-exhaustion-behavior">4.2
メモリ枯渇時の動作（Memory Exhaustion Behavior）</a></li>
</ul></li>
<li><a href="#メモリレイアウト最適化memory-layout-optimization"
id="toc-メモリレイアウト最適化memory-layout-optimization">5.
メモリレイアウト最適化（Memory Layout Optimization）</a>
<ul>
<li><a href="#wasm-線形メモリ配置" id="toc-wasm-線形メモリ配置">5.1 WASM
線形メモリ配置</a></li>
<li><a href="#アライメント戦略alignment-strategy"
id="toc-アライメント戦略alignment-strategy">5.2
アライメント戦略（Alignment Strategy）</a></li>
</ul></li>
<li><a href="#cpu-効率最適化cpu-efficiency-optimization"
id="toc-cpu-効率最適化cpu-efficiency-optimization">6. CPU
効率最適化（CPU Efficiency Optimization）</a>
<ul>
<li><a href="#インタプリタループ最適化"
id="toc-インタプリタループ最適化">6.1 インタプリタループ最適化</a></li>
<li><a href="#タイムスライス設計timeslice-design"
id="toc-タイムスライス設計timeslice-design">6.2
タイムスライス設計（Timeslice Design）</a></li>
</ul></li>
<li><a href="#バイナリサイズ最適化binary-size-optimization"
id="toc-バイナリサイズ最適化binary-size-optimization">7.
バイナリサイズ最適化（Binary Size Optimization）</a>
<ul>
<li><a href="#コンパイルフラグ" id="toc-コンパイルフラグ">7.1
コンパイルフラグ</a></li>
<li><a href="#テンプレート最適化" id="toc-テンプレート最適化">7.2
テンプレート最適化</a></li>
</ul></li>
<li><a href="#プロファイリングprofiling"
id="toc-プロファイリングprofiling">8. プロファイリング（Profiling）</a>
<ul>
<li><a href="#cpu-プロファイリング" id="toc-cpu-プロファイリング">8.1
CPU プロファイリング</a></li>
<li><a href="#メモリプロファイリング"
id="toc-メモリプロファイリング">8.2 メモリプロファイリング</a></li>
</ul></li>
<li><a href="#最適化チェックリストoptimization-checklist"
id="toc-最適化チェックリストoptimization-checklist">9.
最適化チェックリスト（Optimization Checklist）</a></li>
<li><a href="#ベンチマーク結果benchmark-results"
id="toc-ベンチマーク結果benchmark-results">10.
ベンチマーク結果（Benchmark Results）</a>
<ul>
<li><a
href="#reference-implementationcortex-m33100mhz---メインストリーム"
id="toc-reference-implementationcortex-m33100mhz---メインストリーム">10.1
Reference Implementation（Cortex-M33、100MHz -
メインストリーム）</a></li>
<li><a href="#reference-targets-での予想パフォーマンス"
id="toc-reference-targets-での予想パフォーマンス">10.2 Reference Targets
での予想パフォーマンス</a></li>
</ul></li>
<li><a href="#他のランタイムとの比較runtime-comparison"
id="toc-他のランタイムとの比較runtime-comparison">11.
他のランタイムとの比較（Runtime Comparison）</a>
<ul>
<li><a href="#スペック比較表specification-comparison"
id="toc-スペック比較表specification-comparison">11.1
スペック比較表（Specification Comparison）</a></li>
<li><a href="#デバイス容量別ランタイム選択ガイド"
id="toc-デバイス容量別ランタイム選択ガイド">11.2
デバイス容量別ランタイム選択ガイド</a></li>
<li><a href="#用途別推奨ランタイム" id="toc-用途別推奨ランタイム">11.3
用途別推奨ランタイム</a></li>
<li><a href="#デバイス-goldilocks-zone-分析"
id="toc-デバイス-goldilocks-zone-分析">11.4 デバイス “Goldilocks Zone”
分析</a></li>
<li><a href="#詳細スペック分析" id="toc-詳細スペック分析">11.5
詳細スペック分析</a></li>
<li><a href="#実装複雑度の比較" id="toc-実装複雑度の比較">11.6
実装複雑度の比較</a></li>
<li><a href="#フットプリント分析サマリー"
id="toc-フットプリント分析サマリー">11.7
フットプリント分析サマリー</a></li>
<li><a href="#選択フローチャート" id="toc-選択フローチャート">11.8
選択フローチャート</a></li>
</ul></li>
<li><a href="#phase-1-2-実装時の性能確認"
id="toc-phase-1-2-実装時の性能確認">12. Phase 1 &amp; 2
実装時の性能確認</a></li>
<li><a href="#参考資料references" id="toc-参考資料references">13.
参考資料（References）</a></li>
<li><a href="#まとめsummary"
id="toc-まとめsummary">まとめ（Summary）</a></li>
<li><a href="#sloc-ベース見積りsource-lines-of-code-estimation"
id="toc-sloc-ベース見積りsource-lines-of-code-estimation">12. SLOC
ベース見積り（Source Lines of Code Estimation）</a>
<ul>
<li><a href="#コンポーネント別-sloc-見積り"
id="toc-コンポーネント別-sloc-見積り">12.1 コンポーネント別 SLOC
見積り</a></li>
<li><a href="#依存関係と実装順序" id="toc-依存関係と実装順序">12.2
依存関係と実装順序</a></li>
<li><a href="#パフォーマンスとコンプライアンス"
id="toc-パフォーマンスとコンプライアンス">12.3
パフォーマンスとコンプライアンス</a></li>
<li><a href="#sloc-ベース工数見積り" id="toc-sloc-ベース工数見積り">12.4
SLOC ベース工数見積り</a></li>
<li><a href="#コンポーネント複雑度指標"
id="toc-コンポーネント複雑度指標">12.5 コンポーネント複雑度指標</a></li>
<li><a href="#技術的負債保守性指標" id="toc-技術的負債保守性指標">12.6
技術的負債・保守性指標</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="fireball-performance-optimization">Fireball Performance &amp;
Optimization</h1>
<p><strong>Version:</strong> 0.2.0 <strong>Date:</strong> 2025-11-29
<strong>Author:</strong> Takuya Matsunaga</p>
<hr />
<h2 id="overview">Overview</h2>
<p><strong>概要：</strong> Fireball
は、リソース制約のある組み込みシステム向けに最適化されています。本ドキュメントは、メモリフットプリント、CPU
効率、最適化テクニックを説明します。</p>
<p><strong>設計目標（STM32F401ベースライン）：</strong> -
<strong>ROM</strong>: &lt; 128KB（コア実装 + サブシステム） -
<strong>Fireball Core</strong>: ≤ 100KB（マージン30%含む） -
<strong>ゲスト用スペース</strong>: 156KB 以上利用可能 ✅ -
<strong>RAM</strong>: &lt; 32KB（ランタイム + バッファ） -
<strong>Fireball Fixed</strong>: 23.2KB（P1-P4） -
<strong>ゲスト実行時メモリ</strong>: 32-48KB（WAMR より 20% 優位） ✅ -
<strong>コンテキストスイッチ</strong>: &lt; 500 クロック -
<strong>チャネル操作</strong>: &lt; 200 クロック -
<strong>安全マージン</strong>: 20-30%（予期しないオーバーヘッド対応） -
<strong>🎯 ゲストヘッドルーム</strong>: WAMR より優位（OoM
風険なし）</p>
<hr />
<h2 id="メモリ予算memory-budget">1. メモリ予算（Memory Budget）</h2>
<h3 id="rom-予算rom-budget">1.1 ROM 予算（ROM Budget）</h3>
<p>Fireball の ROM
配置は、コンパイル時にバイナリサイズを制御するために設計されています。</p>
<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 17%" />
<col style="width: 35%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>理想値</th>
<th>STM32F401推奨</th>
<th>注記</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>COOS コア</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>co_sched（スケジューラー）</td>
<td>3KB</td>
<td>4KB</td>
<td>Ready queue、コルーチン管理</td>
</tr>
<tr class="odd">
<td>co_csp（CSP チャネル）</td>
<td>2KB</td>
<td>3KB</td>
<td>チャネル実装、wait queue</td>
</tr>
<tr class="even">
<td>co_mem（メモリ管理）</td>
<td>2KB</td>
<td>3KB</td>
<td>dlmalloc wrapper、統計</td>
</tr>
<tr class="odd">
<td>co_value（所有権追跡）</td>
<td>1KB</td>
<td>2KB</td>
<td>テンプレート実装、検証</td>
</tr>
<tr class="even">
<td><strong>COOS Subtotal</strong></td>
<td><strong>8KB</strong></td>
<td><strong>12KB</strong></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>WASM ランタイム</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>インタプリタ（i32/i64）</td>
<td>12KB</td>
<td>18KB</td>
<td>Switch-Case最適化、STL使用容認</td>
</tr>
<tr class="odd">
<td>モジュールローダー</td>
<td>3KB</td>
<td>5KB</td>
<td>セクション解析、スタックトレース対応</td>
</tr>
<tr class="even">
<td>メモリ管理</td>
<td>2KB</td>
<td>3KB</td>
<td>線形メモリ割り当て</td>
</tr>
<tr class="odd">
<td><strong>Runtime Subtotal</strong></td>
<td><strong>17KB</strong></td>
<td><strong>26KB</strong></td>
<td><strong>テンプレート膨張許容</strong></td>
</tr>
<tr class="even">
<td><strong>Subsystems (Native)</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>logger サブシステム</td>
<td>2KB</td>
<td>3KB</td>
<td>リングバッファ、UART backend</td>
</tr>
<tr class="even">
<td>hal サブシステム</td>
<td>3KB</td>
<td>5KB</td>
<td>デバイスルーター、型付きKey-Value形式</td>
</tr>
<tr class="odd">
<td>ipc_router</td>
<td>1KB</td>
<td>2KB</td>
<td>ルーティング、DI コンテナ</td>
</tr>
<tr class="even">
<td>debugger [Phase 3]</td>
<td>3KB</td>
<td>4KB</td>
<td>GDB プロトコル</td>
</tr>
<tr class="odd">
<td><strong>Subsystems Subtotal</strong></td>
<td><strong>9KB</strong></td>
<td><strong>14KB</strong></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Services</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>WASM プラグイン (User)</td>
<td>0-8KB</td>
<td>0-12KB</td>
<td>動的読み込み、STL容認</td>
</tr>
<tr class="even">
<td><strong>Services Subtotal</strong></td>
<td><strong>0-8KB</strong></td>
<td><strong>0-12KB</strong></td>
<td>ユーザー依存</td>
</tr>
<tr class="odd">
<td><strong>Hidden Overhead</strong></td>
<td><strong>12-20KB</strong></td>
<td><strong>15-25KB</strong></td>
<td>テンプレート膨張、例外、RTTI等</td>
</tr>
<tr class="even">
<td><strong>Total (Core)</strong></td>
<td><strong>46-54KB</strong></td>
<td><strong>67-89KB</strong></td>
<td><strong>マージン込み、256KB Flash の 26-35%</strong></td>
</tr>
<tr class="odd">
<td><strong>Recommended Allocation (Core)</strong></td>
<td>&lt; 64KB</td>
<td><strong>&lt; 100KB</strong></td>
<td><strong>20-30% マージン付き</strong></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>🎯 ゲストコードスペース</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Available for Guest (256KB Flash)</strong></td>
<td><strong>192-210KB</strong></td>
<td><strong>156-189KB</strong></td>
<td><strong>ゲストコード、WASM バイナリ用</strong></td>
</tr>
<tr class="odd">
<td><strong>Recommended Guest Allocation</strong></td>
<td>96-128KB</td>
<td><strong>128-160KB</strong></td>
<td><strong>通常のWASMアプリ、余裕持たせ</strong></td>
</tr>
<tr class="even">
<td><strong>Ota/FW Update Reserved</strong></td>
<td>32-64KB</td>
<td><strong>0-32KB</strong></td>
<td><strong>ファームウェア更新領域（柔軟）</strong></td>
</tr>
</tbody>
</table>
<h3 id="rom-見積の現実と検証計画stm32f401ベース">1.1.1 ROM
見積の現実と検証計画（STM32F401ベース）</h3>
<p><strong>🎯 設計方針：ゲストコードスペース最大化</strong></p>
<p>STM32F401は <strong>256KB Flash</strong> を搭載しているため、Fireball
Core
を最小化し、<strong>ゲストアプリケーション用のFlash領域を最大限確保</strong>します。</p>
<p><strong>現実的な推定値（ベストエフォート +
マージン戦略）</strong></p>
<pre><code>理想値（理論）        ： 35KB
隠れたコスト         ： +15-25KB
  - C++ テンプレート膨張：+5-8KB
  - 例外処理テーブル   ：+2-4KB
  - RTTI、libc統合    ：+3-5KB
  - 型付きKey-Value形式、WASM ：+5-8KB

現実的な見積（実装）  ： 50-60KB（最適化あり）
STM32F401での実績値   ： 65-85KB（STL容認、-O2）
マージン30%          ： 100KB上限（推奨）

┌─ Fireball Core    ：≤ 100KB
│                     ↓
├─ Guest Code Space ：156KB 利用可能 ✅ 十分
│  ├─ Typical WASM  ： 128-160KB（通常アプリ）
│  ├─ OTA Update    ： 0-32KB（ファームウェア更新）
│  └─ Headroom      ： 気にしなくて OK
│
└─ 合計           ： 256KB（Flash 100% 活用）</code></pre>
<p><strong>ゲストアプリへの影響：</strong> - WAMR: 40-50KB
実行時メモリ（シビア）→ Fireball: 32-48KB（余裕あり） - WAMR: Flash
超過の可能性 → Fireball: 156KB ゲスト用（充分）</p>
<p><strong>重要な変更点：</strong> - ✅ <strong>STL使用を容認</strong>:
<code>std::vector</code>, <code>std::map</code>,
<code>std::string</code> は使用可能（テンプレート膨張のデメリット &lt;
開発効率のメリット） - ✅ <strong>例外処理有効</strong>:
<code>-fno-exceptions</code> は不適用。例外安全性を重視 - ✅
<strong>RTTI有効</strong>: <code>-fno-rtti</code>
は不適用。dynamic_cast、typeid等の利用可能 - ✅
<strong>マージン30%</strong>:
予期しないオーバーヘッド対応（最大100KB）</p>
<h4 id="poc-段階での検証計画"><strong>PoC 段階での検証計画</strong></h4>
<p>以下の順序で実装し、実際のコンパイルサイズを測定します：</p>
<ol type="1">
<li><p><strong>Phase 0: コア最小実装</strong></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># co_sched + co_csp + co_mem のみ</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">arm-none-eabi-size</span> core.elf</span></code></pre></div>
<ul>
<li>理想値：5-7KB</li>
<li>STM32F401実績：8-12KB（マージン込み）</li>
</ul></li>
<li><p><strong>Phase 1: WASM インタプリタ最小版</strong></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># コア + Interpreter (i32/i64、~60命令)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">arm-none-eabi-size</span> core_interpreter.elf</span></code></pre></div>
<ul>
<li>理想値：12-18KB</li>
<li>STM32F401実績：20-30KB（STL容認、スタックトレース対応）</li>
</ul></li>
<li><p><strong>Phase 2: logger + HAL サブシステム</strong></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># コア + Interpreter + logger + hal</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">arm-none-eabi-size</span> with_subsystems.elf</span></code></pre></div>
<ul>
<li>理想値：20-30KB</li>
<li>STM32F401実績：40-55KB（型付きKey-Value形式、IPC Router含む）</li>
</ul></li>
<li><p><strong>Phase 3: 完全実装（debugger含む）</strong></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 完全実装</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">arm-none-eabi-size</span> full.elf</span></code></pre></div>
<ul>
<li>理想値：35-45KB</li>
<li>STM32F401実績：65-85KB（GDB RSP、サービス統合）</li>
<li><strong>許容上限：100KB（マージン30%）</strong></li>
</ul></li>
</ol>
<h4
id="コンパイラフラグ最適化stm32f401推奨"><strong>コンパイラフラグ最適化（STM32F401推奨）</strong></h4>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CMakeLists.txt - Release ビルド設定</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(<span class="dv">CMAKE_CXX_FLAGS_RELEASE</span> <span class="st">&quot;-O2 -flto -fno-unroll-loops&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 備考:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   - -O2：バランス型最適化（-Os よりもコード密度が良好、かつ開発効率良好）</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   - -flto：リンクタイム最適化（10-15% サイズ削減）</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   - -fno-exceptions は不適用（例外安全性重視）</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   - -fno-rtti は不適用（dynamic_cast/typeid を許容）</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(<span class="dv">CMAKE_EXE_LINKER_FLAGS</span> <span class="st">&quot;</span><span class="dv">${CMAKE_EXE_LINKER_FLAGS}</span><span class="st"> -Wl,--gc-sections -Wl,--print-memory-usage&quot;</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 備考：未使用セクション削除、メモリ使用量レポート</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># サイズ分析（実装後）</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. テキストセクション総サイズ確認</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">arm-none-eabi-size full.elf</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. 大きいシンボル特定（トップ 20）</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">arm-none-eabi-nm --print-size --size-sort full.elf | tail -20</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. セクション別分析</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="fu">arm-none-eabi-objdump -h full.elf | grep &quot;\.text\|\.data\|\.rodata&quot;</span></span></code></pre></div>
<p><strong>コンパイルコマンド例:</strong></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> build</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release ..</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> VERBOSE=1</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">arm-none-eabi-size</span> fireball.elf</span></code></pre></div>
<h4 id="rom-予算の段階的見直しstm32f401ベース"><strong>ROM
予算の段階的見直し（STM32F401ベース）</strong></h4>
<table>
<thead>
<tr class="header">
<th>段階</th>
<th>実測結果</th>
<th>判断</th>
<th>次のアクション</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>PoC Phase 0（コア）</strong></td>
<td>8-12KB</td>
<td>✅ OK</td>
<td>Phase 1へ</td>
</tr>
<tr class="even">
<td><strong>PoC Phase 1（インタプリタ）</strong></td>
<td>20-30KB</td>
<td>✅ OK</td>
<td>Phase 2へ</td>
</tr>
<tr class="odd">
<td><strong>PoC Phase 2（サブシステム）</strong></td>
<td>40-55KB</td>
<td>✅ OK</td>
<td>Phase 3へ</td>
</tr>
<tr class="even">
<td><strong>PoC Phase 3（完全）</strong></td>
<td>65-85KB</td>
<td>✅ OK</td>
<td>本実装開始（余裕あり）</td>
</tr>
<tr class="odd">
<td><strong>現実的上限</strong></td>
<td>85-100KB</td>
<td>✅ OK</td>
<td>許容範囲、マージン30%</td>
</tr>
<tr class="even">
<td>～</td>
<td>100-120KB</td>
<td>⚠️ 検討</td>
<td>STL使用削減、遅延ロード検討</td>
</tr>
<tr class="odd">
<td>～</td>
<td>120KB+</td>
<td>❌ NG</td>
<td>アーキテクチャ見直し必要</td>
</tr>
</tbody>
</table>
<h4
id="重要な設計判断stm32f401対応"><strong>重要な設計判断（STM32F401対応）</strong></h4>
<p>✅
<strong>STM32F401は十分な容量を備えているため、以下の判断は既に確定：</strong></p>
<ol type="1">
<li><strong>STL使用容認</strong> → テンプレート膨張は許容（開発効率 &gt;
コンパイラ制約）</li>
<li><strong>例外処理有効</strong> → <code>-fno-exceptions</code>
は使用しない（例外安全性 &gt; ROPガジェット削減）</li>
<li><strong>RTTI有効</strong> → <code>-fno-rtti</code>
は使用しない（dynamic_cast、typeid許容）</li>
<li><strong>マージン30%確保</strong> → 100KB を許容上限に設定（256KB
Flash の 39% 使用）</li>
</ol>
<p><strong>実装中の段階:</strong> - PoC Phase 0-3が すべて ✅ OK
判定で進行する想定 - 100KB 超過時のみ、遅延ロード等の構造改善を検討 -
120KB 超過時のみ、アーキテクチャ見直し（分割バイナリ等）を検討</p>
<hr />
<h3 id="ram-予算ram-budget---stm32f401ベース">1.2 RAM 予算（RAM Budget -
STM32F401ベース）</h3>
<p><strong>STM32F401は 96KB SRAM を搭載</strong>しているため、従来の 4KB
制約から大幅に緩和されました。</p>
<p>Fireball の RAM 予算は、アーキテクチャの仕様から導出された以下の
<strong>6
つの独立したヒープパーティション</strong>で構成されます。<strong>Subsystems（logger,
hal ネイティブ実装）とServices（ユーザー提供 WASM
プラグイン）を分離</strong>することで、サービス障害がシステムに波及しない耐障害性を実現します。ゲストモジュールは実行時に
1 つのみという前提に基づいています。</p>
<p><strong>🎯 ゲストヘッドルーム重視の最適化（STM32F401 96KB
SRAM）:</strong></p>
<table>
<colgroup>
<col style="width: 39%" />
<col style="width: 18%" />
<col style="width: 24%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>容量</th>
<th>利用率</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Fireball Core (P1-P4)</strong></td>
<td>23.2KB</td>
<td>24%</td>
<td>スケジューラ、HAL、logger、debugger</td>
</tr>
<tr class="even">
<td><strong>ゲストモジュールヒープ</strong></td>
<td><strong>32-48KB</strong></td>
<td><strong>33-50%</strong></td>
<td>✅ <strong>WAMR より 20% 以上の余裕</strong></td>
</tr>
<tr class="odd">
<td><strong>システムマージン</strong></td>
<td>16-32KB</td>
<td>17-33%</td>
<td>✅ <strong>安全バッファ、20% 確保</strong></td>
</tr>
<tr class="even">
<td><strong>TOTAL</strong></td>
<td>63-80KB</td>
<td>66-83%</td>
<td><strong>SRAM の約 70%</strong></td>
</tr>
</tbody>
</table>
<p><strong>重要：Fireballはゲストアプリケーションの実行時メモリに最適化</strong>
- WAMR（最悪ケース）: 80-104KB → <strong>Out-Of-Memory 風険</strong> -
<strong>Fireball: 63-80KB → 安全で拡張可能</strong> - ゲストが 48KB
を超えるバッファが必要？→ Fireball はマージンから借用可能（最大 80KB
迄）</p>
<h4 id="固定オーバーヘッド分解6分割---stm32f401ベース"><strong>1.2.1
固定オーバーヘッド分解（6分割 - STM32F401ベース）</strong></h4>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 15%" />
<col style="width: 35%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>最小</th>
<th>STM32F401推奨</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>[P1] COOS Kernel Heap</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>co_sched (Ready queue 8 coro)</td>
<td>320B</td>
<td>512B</td>
<td>Queue nodes: 256B + Metadata: 256B</td>
</tr>
<tr class="odd">
<td>co_csp (16 channels, 8 wait states)</td>
<td>2.0KB</td>
<td>3.0KB</td>
<td>Channels: 1.5KB + Wait queues: 1.5KB</td>
</tr>
<tr class="even">
<td>co_mem (dlmalloc metadata)</td>
<td>896B</td>
<td>1.2KB</td>
<td>Heap state: 512B + mspace headers: 640B +統計</td>
</tr>
<tr class="odd">
<td>co_value (64 tracked values)</td>
<td>512B</td>
<td>1.0KB</td>
<td>Ownership registry: 768B + Metadata: 256B</td>
</tr>
<tr class="even">
<td><strong>P1 Subtotal</strong></td>
<td><strong>3.7KB</strong></td>
<td><strong>5.7KB</strong></td>
<td>✅ リソース増加を許容</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>[P2] WASM Runtime Heap</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Interpreter state (1 guest)</td>
<td>1.5KB</td>
<td>2.5KB</td>
<td>PC/SP/FP/value stack (512×4B) + デバッグ情報</td>
</tr>
<tr class="even">
<td>Module loader metadata</td>
<td>624B</td>
<td>1.2KB</td>
<td>Export tables, code/data sections + リロケーション</td>
</tr>
<tr class="odd">
<td>Execution context</td>
<td>0B</td>
<td>1.0KB</td>
<td>エラー情報、スタックトレース（開発効率向上）</td>
</tr>
<tr class="even">
<td><strong>P2 Subtotal</strong></td>
<td><strong>2.1KB</strong></td>
<td><strong>4.7KB</strong></td>
<td>✅ スタックトレース対応</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>[P3] Subsystems Heap (Native)</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>router (IPC hub, encode/decode)</td>
<td>1.4KB</td>
<td>2.2KB</td>
<td>Routing table (1KB) + buffers (1KB) + metadata (200B)</td>
</tr>
<tr class="even">
<td>logger (ring buffer + events)</td>
<td>2.0KB</td>
<td>3.0KB</td>
<td>Event ring (256×8B) + queue nodes</td>
</tr>
<tr class="odd">
<td>hal (device registry + routing)</td>
<td>1.8KB</td>
<td>2.8KB</td>
<td>Devices (16×48B) + routing table + キャッシュ</td>
</tr>
<tr class="even">
<td>debugger (breakpoint storage)</td>
<td>0B</td>
<td>0.8KB</td>
<td>Max 10 breakpoints、register snapshot</td>
</tr>
<tr class="odd">
<td><strong>P3 Subtotal</strong></td>
<td><strong>5.2KB</strong></td>
<td><strong>8.8KB</strong></td>
<td>✅ デバッグ機能拡張</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>[P4] Services Heap (WASM plugins)</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Service registry</td>
<td>256B</td>
<td>512B</td>
<td>Service handles + routing + メタデータ</td>
</tr>
<tr class="odd">
<td>Initial allocation (dynamic)</td>
<td>0B</td>
<td>0B</td>
<td>動的読み込み時に割り当て</td>
</tr>
<tr class="even">
<td><strong>P4 Subtotal</strong></td>
<td><strong>0.3KB</strong></td>
<td><strong>0.5KB</strong></td>
<td>小規模</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Global Infrastructure</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Device map</td>
<td>256B</td>
<td>512B</td>
<td>Static handle table（デバイス数増加）</td>
</tr>
<tr class="even">
<td>Breakpoint table</td>
<td>160B</td>
<td>480B</td>
<td>Max 10 breakpoints (拡張）</td>
</tr>
<tr class="odd">
<td>Coroutine context pool (8 coro)</td>
<td>192B</td>
<td>512B</td>
<td>Context metadata + スタック情報</td>
</tr>
<tr class="even">
<td>IPC message buffers</td>
<td>512B</td>
<td>1.5KB</td>
<td>Channel queues + 一時バッファ</td>
</tr>
<tr class="odd">
<td>System metadata</td>
<td>256B</td>
<td>512B</td>
<td>State, configuration, timestamps, 統計</td>
</tr>
<tr class="even">
<td><strong>Global Subtotal</strong></td>
<td><strong>1.4KB</strong></td>
<td><strong>3.5KB</strong></td>
<td>✅ 統計情報追加</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>========== FIXED MINIMUM =========</strong></td>
<td><strong>12.8KB</strong></td>
<td><strong>23.2KB</strong></td>
<td><strong>P1+P2+P3+P4+Global</strong></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>[P5] Guest Module Heap</strong></td>
<td>24KB</td>
<td><strong>32-48KB</strong></td>
<td><strong>ユーザーアプリケーション用、拡大</strong></td>
</tr>
<tr class="odd">
<td><strong>[P6] System Reserve</strong></td>
<td>512B</td>
<td><strong>2-4KB</strong></td>
<td><strong>緊急用、拡大</strong></td>
</tr>
<tr class="even">
<td><strong>Coroutine Stack Area</strong></td>
<td>8KB</td>
<td><strong>8KB</strong></td>
<td>8 coroutines × 1KB</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>TOTAL (96KB SRAM)</strong></td>
<td><strong>46-54KB</strong></td>
<td><strong>63-80KB</strong></td>
<td><strong>推奨マージン 16-32KB（最低 16%）</strong></td>
</tr>
</tbody>
</table>
<h4 id="ゲストヘッドルーム優位性分析vs-wamr"><strong>1.2.1.1
ゲストヘッドルーム優位性分析（vs WAMR）</strong></h4>
<p><strong>STM32F401（96KB SRAM）での比較：</strong></p>
<table>
<thead>
<tr class="header">
<th>項目</th>
<th>WAMR（標準）</th>
<th>Fireball</th>
<th>差分（優位性）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Runtime固定OH</strong></td>
<td>18-24KB</td>
<td>23.2KB</td>
<td>-5.2KB（同等）</td>
</tr>
<tr class="even">
<td><strong>ゲスト割当可能</strong></td>
<td>40-50KB</td>
<td><strong>32-48KB</strong></td>
<td>-8-16KB（ほぼ同等）</td>
</tr>
<tr class="odd">
<td><strong>マージン/予約</strong></td>
<td>20-30KB</td>
<td>16-32KB</td>
<td>-0-14KB（やや有利）</td>
</tr>
<tr class="even">
<td><strong>システムRAM利用率</strong></td>
<td>70-90%</td>
<td>63-83%</td>
<td><strong>✅ 7-27pp優位</strong></td>
</tr>
</tbody>
</table>
<p><strong>詳細分析：</strong></p>
<pre><code>WAMR（STM32F401 実績）:
├─ Core Runtime       : 20-24KB（インタプリタ + VM overhead）
├─ Guest Module Heap  : 40-50KB（典型的なアプリ）
├─ System Reserve     : 20-30KB（安全マージン）
└─ TOTAL            : 80-104KB（最悪ケース 104KB &gt; 96KB ⚠️ 超過風険あり）

Fireball（STM32F401 目標）:
├─ Core (P1-P4)      : 23.2KB（スケジューラ + HAL + logger）
├─ Guest Module Heap : 32-48KB（同等のアプリ動作、柔軟に拡張可能）
├─ System Reserve    : 16-32KB（20% マージン、効率的）
└─ TOTAL            : 63-80KB（最悪ケース 80KB &lt; 96KB ✅ 安全）</code></pre>
<p><strong>Fireballの優位性：</strong></p>
<ol type="1">
<li><strong>ゲスト実行時の自由度向上</strong>
<ul>
<li>WAMRの最悪ケース 104KB → Fireball 80KB（24KB削減）</li>
<li>ゲストが大規模バッファ必要な場合、WAMR は Out-Of-Memory → Fireball
は許容</li>
</ul></li>
<li><strong>システムの安定性</strong>
<ul>
<li>WAMR: 80-104KB（シビア、マージン不足）</li>
<li>Fireball: 63-80KB（安定運用、16-32KB 確保）</li>
</ul></li>
<li><strong>予測可能性</strong>
<ul>
<li>Fireballは 6分割パーティション設計により、各コンポーネント独立</li>
<li>パーティション 5（ゲスト）の拡張性が高い</li>
<li>Service/Guest の障害が他に波及しない</li>
</ul></li>
<li><strong>スケーラビリティ</strong>
<ul>
<li>将来 STM32H7（512KB SRAM）への移植時、ゲスト割当を 200KB+
に拡張可能</li>
<li>WAMRはスケール困難（各コンポーネント比率が固定）</li>
</ul></li>
</ol>
<h4 id="ヒープパーティション戦略6分割アーキテクチャ"><strong>1.2.2
ヒープパーティション戦略（6分割アーキテクチャ）</strong></h4>
<p>システム RAM を以下の <strong>6
つの独立したヒープ</strong>に分割します。<strong>Subsystems（logger,
hal）とServices（ユーザープラグイン）を分離</strong>し、サービスの障害がコアシステムに波及しないようにします：</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 9%" />
<col style="width: 21%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 13%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Partition</th>
<th>最小</th>
<th>STM32F401推奨</th>
<th>最大</th>
<th>目的</th>
<th>管理方式</th>
<th>失敗時の影響</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>1. COOS Kernel Heap</strong></td>
<td>512B</td>
<td>5.7KB</td>
<td>8.0KB</td>
<td>co_sched, co_csp, co_mem, co_value メタデータ</td>
<td>固定割り当て</td>
<td>システムパニック</td>
</tr>
<tr class="even">
<td><strong>2. WASM Runtime Heap</strong></td>
<td>2.0KB</td>
<td>4.7KB</td>
<td>10.0KB</td>
<td>Interpreter state, module loader, 実行コンテキスト</td>
<td>固定割り当て</td>
<td>システムパニック</td>
</tr>
<tr class="odd">
<td><strong>3. Subsystems Heap</strong></td>
<td>2.0KB</td>
<td>8.8KB</td>
<td>12.0KB</td>
<td>router (IPC hub), logger, hal, debugger ネイティブ実装</td>
<td>dlmalloc mspace</td>
<td>IPC 停止 + デバッグ喪失（機能継続）</td>
</tr>
<tr class="even">
<td><strong>4. Services Heap</strong></td>
<td>2.0KB</td>
<td>4.0KB</td>
<td>8.0KB</td>
<td>ユーザー WASM サービスプラグイン</td>
<td>dlmalloc mspace</td>
<td><strong>サービスのみ終了</strong> ✓</td>
</tr>
<tr class="odd">
<td><strong>5. Guest Module Heap</strong></td>
<td>24KB</td>
<td><strong>32-48KB</strong></td>
<td>残余</td>
<td>ゲストアプリケーション用、大幅拡大</td>
<td><strong>Per-module mspace</strong></td>
<td>ゲストのみ終了</td>
</tr>
<tr class="even">
<td><strong>6. Coroutine Stack Area</strong></td>
<td>8KB</td>
<td>8KB</td>
<td>16KB</td>
<td>8-16 コルーチンスタック（1KB/coro）</td>
<td>スタック領域</td>
<td>コルーチン数制限</td>
</tr>
<tr class="odd">
<td><strong>7. System Reserve</strong></td>
<td>512B</td>
<td><strong>2-4KB</strong></td>
<td>4KB</td>
<td>緊急割り当て、エラー回復</td>
<td>予約(使用禁止)</td>
<td>N/A</td>
</tr>
<tr class="even">
<td><strong>TOTAL ALLOCATION</strong></td>
<td>39-50KB</td>
<td><strong>63-80KB</strong></td>
<td>96KB</td>
<td><strong>96KB SRAM</strong></td>
<td>6分割</td>
<td>マージン 16-32KB（最低16%）</td>
</tr>
</tbody>
</table>
<p><strong>重要な設計原則：</strong> - <strong>Partition 1-2</strong>:
COOS カーネル、固定割り当て、絶対に失敗しない - <strong>Partition
3</strong>: logger + hal Subsystems（ネイティブ
C++）、システム機能の一部 - <strong>Partition 4</strong>: ユーザー提供の
WASM サービスプラグイン、独立隔離 ← <strong>新規分離</strong> -
<strong>Partition 5</strong>: ゲストアプリケーション、完全独立 -
<strong>Partition 6</strong>: 予約領域、緊急回復用</p>
<p><strong>パーティション隔離の利点：</strong> 1.
<strong>耐障害性（Fault Isolation）</strong>: Service が枯渇 → Service
のみ終了、他システム継続 2. <strong>割り当て性能向上</strong>: mspace
内のみ走査、O(m) vs O(n) 3. <strong>統計情報の正確性</strong>:
各コンポーネント毎の使用量追跡 4. <strong>セキュリティ</strong>:
ユーザーコード（Services, Guest）がシステムメモリを汚染できない</p>
<p><strong>各パーティションの失敗シナリオ：</strong></p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="header">
<th>Partition</th>
<th>枯渇時の動作</th>
<th>システムへの影響</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Partition 1 (COOS Kernel)</td>
<td>System Reset</td>
<td>❌ 完全システム停止</td>
</tr>
<tr class="even">
<td>Partition 2 (WASM Runtime)</td>
<td>System Reset</td>
<td>❌ 完全システム停止</td>
</tr>
<tr class="odd">
<td>Partition 3 (Subsystems)</td>
<td>logger/hal に ERROR イベント → logger のみ出力不可</td>
<td>⚠️ デバッグ機能喪失だが制御継続</td>
</tr>
<tr class="even">
<td>Partition 4 (Services)</td>
<td>Service を terminate → IPC handler 設定</td>
<td>✓ Service のみ終了、他は継続</td>
</tr>
<tr class="odd">
<td>Partition 5 (Guest)</td>
<td>Guest module を unload</td>
<td>✓ Guest のみ終了、System 継続</td>
</tr>
<tr class="even">
<td>Partition 6 (Reserve)</td>
<td>Never used (reserved)</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h4 id="プラットフォーム別-ram-割り当て例6分割"><strong>1.2.3
プラットフォーム別 RAM 割り当て例（6分割）</strong></h4>
<p><strong>32KB システム（最小 IoT デバイス）:</strong></p>
<pre><code>Total RAM: 32KB = 32768 bytes
┌──────────────────────────────────────┐
│ Partition 1 (COOS Kernel):  1.5 KB   │ co_sched, co_csp, co_mem
│ Partition 2 (WASM Runtime):  4.0 KB   │ Interpreter, module loader
│ Partition 3 (Subsystems):    4.0 KB   │ router (IPC hub), logger, hal
│ Partition 4 (Services):      4.0 KB   │ User WASM service plugins
│ Partition 6 (System Reserve): 2.5 KB  │ Emergency allocation
├──────────────────────────────────────┤
│ SUBTOTAL:                  16.0 KB    │
│ Coroutine Stacks (4×2KB):   8.0 KB    │
├──────────────────────────────────────┤
│ Total Fixed:               24.0 KB    │
│                                       │
│ Partition 5 (Guest Heap):   8.0 KB    │ ← Remaining for user application
└──────────────────────────────────────┘

隔離効果：
- Service 枯渇 → Service のみ終了（Host+Guest 継続）✓
- Guest 枯渇 → Guest のみ unload（Host+Service 継続）✓
- Subsystem 枯渇 → デバッグ喪失（制御は継続）⚠️

ゲストアプリケーション例（C/Clang + wasi-libc）:
```c
// guest_app.c: ADC sensor buffering + wireless transmission
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

// Fireball HAL interface (imported via WASM)
extern int hal_adc_read(int channel);
extern int hal_tx_send(const uint8_t* data, int len);
extern void ch_send(int ch_id, int value);

#define BUFFER_SIZE 64
#define SENSOR_CHANNEL 0

typedef struct {
    int16_t samples[BUFFER_SIZE];
    int count;
} sensor_buffer_t;

sensor_buffer_t sensor_buf = {0};

void sensor_task() {
    while (1) {
        // Read ADC
        int value = hal_adc_read(SENSOR_CHANNEL);

        // Buffer sample
        sensor_buf.samples[sensor_buf.count++] = (int16_t)value;

        // Send when buffer full
        if (sensor_buf.count &gt;= BUFFER_SIZE) {
            // Transmit via wireless
            hal_tx_send((uint8_t*)sensor_buf.samples,
                       BUFFER_SIZE * sizeof(int16_t));
            sensor_buf.count = 0;
        }

        // Yield to other coroutines
        ch_send(0, 1);
    }
}

int main() {
    memset(&amp;sensor_buf, 0, sizeof(sensor_buf));
    sensor_task();
    return 0;
}</code></pre>
<p><strong>RAM 構成:</strong> - wasi-libc セクション: ~1-2KB
(最小化ビルド) - 静的データ: ~1KB (sensor_buf など) - 動作用ヒープ:
~4-6KB - <strong>合計: ~8KB</strong></p>
<p><strong>64KB システム（標準 IoT デバイス）:</strong></p>
<table>
<colgroup>
<col style="width: 44%" />
<col style="width: 32%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>サイズ</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Partition 1 (COOS Kernel)</td>
<td>1.5 KB</td>
<td>16 channels, full metadata</td>
</tr>
<tr class="even">
<td>Partition 2 (WASM Runtime)</td>
<td>4.0 KB</td>
<td>Large value stack, module buffer</td>
</tr>
<tr class="odd">
<td>Partition 3 (Subsystems)</td>
<td>4.0 KB</td>
<td>router, logger ring, hal registry</td>
</tr>
<tr class="even">
<td>Partition 4 (Services)</td>
<td>4.0 KB</td>
<td>Multiple service plugins possible</td>
</tr>
<tr class="odd">
<td>Partition 6 (System Reserve)</td>
<td>2.5 KB</td>
<td>Emergency allocation</td>
</tr>
<tr class="even">
<td><strong>SUBTOTAL</strong></td>
<td><strong>16.0 KB</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>Coroutine Stacks (8×4KB)</td>
<td>32.0 KB</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Total Fixed</strong></td>
<td><strong>48.0 KB</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>Partition 5 (Guest Heap)</td>
<td><strong>16.0 KB</strong></td>
<td>← Remaining for user application</td>
</tr>
<tr class="even">
<td><strong>TOTAL RAM</strong></td>
<td><strong>64.0 KB</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>隔離効果： - Service + Guest を同時実行可能（両者が独立）✓ - Service
が Guest のメモリを侵食できない ✓ - Subsystem 枯渇しにくい（4KB
割り当て）✓</p>
<p>ゲストアプリケーション例（C/Clang + wasi-libc）:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// guest_app.c: Multi-sensor data aggregation with statistics</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_adc_read<span class="op">(</span><span class="dt">int</span> channel<span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_tx_send<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span><span class="op">*</span> data<span class="op">,</span> <span class="dt">int</span> len<span class="op">);</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> ch_send<span class="op">(</span><span class="dt">int</span> ch_id<span class="op">,</span> <span class="dt">int</span> value<span class="op">);</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_SENSORS </span><span class="dv">4</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SAMPLES_PER_SENSOR </span><span class="dv">32</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#define STAT_WINDOW </span><span class="dv">256</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> min<span class="op">,</span> max<span class="op">,</span> sum<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> count<span class="op">;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> stats_t<span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int16_t</span> samples<span class="op">[</span>NUM_SENSORS<span class="op">][</span>SAMPLES_PER_SENSOR<span class="op">];</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> idx<span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    stats_t stats<span class="op">[</span>NUM_SENSORS<span class="op">];</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> aggregator_t<span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>aggregator_t agg <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> update_stats<span class="op">(</span><span class="dt">int</span> sensor_id<span class="op">,</span> <span class="dt">int16_t</span> sample<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    stats_t<span class="op">*</span> s <span class="op">=</span> <span class="op">&amp;</span>agg<span class="op">.</span>stats<span class="op">[</span>sensor_id<span class="op">];</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>count <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        s<span class="op">-&gt;</span>min <span class="op">=</span> s<span class="op">-&gt;</span>max <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sample <span class="op">&lt;</span> s<span class="op">-&gt;</span>min<span class="op">)</span> s<span class="op">-&gt;</span>min <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sample <span class="op">&gt;</span> s<span class="op">-&gt;</span>max<span class="op">)</span> s<span class="op">-&gt;</span>max <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    s<span class="op">-&gt;</span>sum <span class="op">+=</span> sample<span class="op">;</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    s<span class="op">-&gt;</span>count<span class="op">++;</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reset every STAT_WINDOW samples</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>count <span class="op">&gt;=</span> STAT_WINDOW<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        s<span class="op">-&gt;</span>count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        s<span class="op">-&gt;</span>sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> aggregator_task<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(&amp;</span>agg<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>agg<span class="op">));</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> value <span class="op">=</span> hal_adc_read<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int16_t</span> sample <span class="op">=</span> <span class="op">(</span><span class="dt">int16_t</span><span class="op">)</span>value<span class="op">;</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            agg<span class="op">.</span>samples<span class="op">[</span>i<span class="op">][</span>agg<span class="op">.</span>idx<span class="op">]</span> <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            update_stats<span class="op">(</span>i<span class="op">,</span> sample<span class="op">);</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        agg<span class="op">.</span>idx<span class="op">++;</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>agg<span class="op">.</span>idx <span class="op">&gt;=</span> SAMPLES_PER_SENSOR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transmit aggregated data</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>            hal_tx_send<span class="op">((</span><span class="dt">uint8_t</span><span class="op">*)</span>agg<span class="op">.</span>samples<span class="op">,</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">sizeof</span><span class="op">(</span>agg<span class="op">.</span>samples<span class="op">));</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>            agg<span class="op">.</span>idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        ch_send<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    aggregator_task<span class="op">();</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>RAM 構成:</strong> - wasi-libc: ~1-2KB - 静的構造体
(aggregator_t): ~3KB - 4 sensors × 32 samples × 2 bytes = 256B - 4 stats
× 16 bytes = 64B - 計約 ~3-4KB - 動作用ヒープ: ~4-6KB - <strong>合計:
~9-12KB / 16KB</strong></p>
<p>ゲストサービス例（Custom Sensor Driver）:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service_plugin.c: Bluetooth mesh gateway</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_ble_init<span class="op">(</span><span class="dt">int</span> profile_id<span class="op">);</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_ble_send<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span><span class="op">*</span> data<span class="op">,</span> <span class="dt">int</span> len<span class="op">);</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> ch_recv<span class="op">(</span><span class="dt">int</span> ch_id<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> value<span class="op">);</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_NODES </span><span class="dv">8</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> node_id<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> last_seen<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> mesh_node_t<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>mesh_node_t mesh_nodes<span class="op">[</span>MAX_NODES<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> node_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mesh_gateway<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    hal_ble_init<span class="op">(</span><span class="bn">0x01</span><span class="op">);</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> incoming<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        ch_recv<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>value<span class="op">);</span>  <span class="co">// Receive from main app</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>node_count <span class="op">&lt;</span> MAX_NODES<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            mesh_nodes<span class="op">[</span>node_count<span class="op">].</span>node_id <span class="op">=</span> <span class="op">(</span><span class="dt">uint8_t</span><span class="op">)</span>value<span class="op">;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            node_count<span class="op">++;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Broadcast to all mesh nodes</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> node_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>            hal_ble_send<span class="op">((</span><span class="dt">uint8_t</span><span class="op">*)&amp;</span>mesh_nodes<span class="op">[</span>i<span class="op">],</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">sizeof</span><span class="op">(</span>mesh_node_t<span class="op">));</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        ch_recv<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>value<span class="op">);</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>RAM 構成:</strong> - wasi-libc: ~1-2KB - 静的データ
(mesh_nodes): ~128B - 動作用ヒープ: ~1-2KB - <strong>合計: ~2-4KB /
4KB</strong></p>
<p><strong>128KB システム（エッジ・高性能デバイス）:</strong></p>
<table>
<colgroup>
<col style="width: 44%" />
<col style="width: 32%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>サイズ</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Partition 1 (COOS Kernel)</td>
<td>1.5 KB</td>
<td>Full 32-channel capacity</td>
</tr>
<tr class="even">
<td>Partition 2 (WASM Runtime)</td>
<td>4.0 KB</td>
<td>Extended interpreter buffers</td>
</tr>
<tr class="odd">
<td>Partition 3 (Subsystems)</td>
<td>4.0 KB</td>
<td>router, full logger, hal + stats</td>
</tr>
<tr class="even">
<td>Partition 4 (Services)</td>
<td>4.0 KB</td>
<td>Multiple complex service plugins</td>
</tr>
<tr class="odd">
<td>Partition 6 (System Reserve)</td>
<td>2.5 KB</td>
<td>Large emergency reserve</td>
</tr>
<tr class="even">
<td><strong>SUBTOTAL</strong></td>
<td><strong>16.0 KB</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>Coroutine Stacks (16×4KB)</td>
<td>64.0 KB</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Total Fixed</strong></td>
<td><strong>80.0 KB</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>Partition 5 (Guest Heap)</td>
<td><strong>48.0 KB</strong></td>
<td>← Abundant space for complex apps</td>
</tr>
<tr class="even">
<td><strong>TOTAL RAM</strong></td>
<td><strong>128.0 KB</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>隔離効果： - Service と Guest を完全に分離（各 4-48KB）✓ - 複数の
Service plugin 同時実行可能 ✓ - Subsystem 枯渇の可能性低い ✓</p>
<p>ゲストアプリケーション例（C/Clang + wasi-libc）:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// guest_app.c: Time-series sensor aggregation with histogram statistics</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">// 用途: Environmental monitoring (温度・湿度・CO2) + Machine learning inference</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;math.h&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Fireball HAL interface</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_adc_read<span class="op">(</span><span class="dt">int</span> channel<span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_tx_send<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span><span class="op">*</span> data<span class="op">,</span> <span class="dt">int</span> len<span class="op">);</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> ch_send<span class="op">(</span><span class="dt">int</span> ch_id<span class="op">,</span> <span class="dt">int</span> value<span class="op">);</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_get_time_ms<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_SENSORS </span><span class="dv">3</span><span class="pp">               </span><span class="co">// Temperature, Humidity, CO2</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SAMPLES_PER_WINDOW </span><span class="dv">128</span><span class="pp">      </span><span class="co">// Sliding window buffer</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#define HISTOGRAM_BINS </span><span class="dv">32</span><span class="pp">           </span><span class="co">// Frequency distribution</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#define HISTORY_DEPTH </span><span class="dv">256</span><span class="pp">           </span><span class="co">// Long-term trend storage</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MODEL_WEIGHTS </span><span class="dv">64</span><span class="pp">            </span><span class="co">// Simple ML coefficients</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int16_t</span> value<span class="op">;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> timestamp<span class="op">;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> sample_t<span class="op">;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sliding window for real-time statistics</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    sample_t window<span class="op">[</span>SAMPLES_PER_WINDOW<span class="op">];</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> window_idx<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Histogram for distribution analysis</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> histogram<span class="op">[</span>HISTOGRAM_BINS<span class="op">];</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Running statistics</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> sum<span class="op">;</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> min<span class="op">;</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> max<span class="op">;</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> count<span class="op">;</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> sensor_aggregator_t<span class="op">;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ML model coefficients (simple linear model)</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> weights<span class="op">[</span>MODEL_WEIGHTS<span class="op">];</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> bias<span class="op">;</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Model input cache</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> features<span class="op">[</span>NUM_SENSORS <span class="op">*</span> <span class="dv">3</span><span class="op">];</span>  <span class="co">// min, avg, max per sensor</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ml_model_t<span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Global state (managed within 48KB guest heap)</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>sensor_aggregator_t aggregators<span class="op">[</span>NUM_SENSORS<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>ml_model_t ml_model <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> iteration_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple histogram update</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> update_histogram<span class="op">(</span>sensor_aggregator_t<span class="op">*</span> agg<span class="op">,</span> <span class="dt">int16_t</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Map value to histogram bin (assuming 16-bit signed range)</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bin 0 = -32768, Bin 31 = +32767</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> bin <span class="op">=</span> <span class="op">((</span><span class="dt">uint32_t</span><span class="op">)(</span>value <span class="op">+</span> <span class="dv">32768</span><span class="op">)</span> <span class="op">*</span> HISTOGRAM_BINS<span class="op">)</span> <span class="op">/</span> <span class="dv">65536</span><span class="op">;</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>bin <span class="op">&gt;=</span> HISTOGRAM_BINS<span class="op">)</span> bin <span class="op">=</span> HISTOGRAM_BINS <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>histogram<span class="op">[</span>bin<span class="op">]++;</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="co">// Update real-time statistics</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> update_statistics<span class="op">(</span>sensor_aggregator_t<span class="op">*</span> agg<span class="op">,</span> <span class="dt">int16_t</span> sample<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to sliding window</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>window<span class="op">[</span>agg<span class="op">-&gt;</span>window_idx<span class="op">].</span>value <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>window<span class="op">[</span>agg<span class="op">-&gt;</span>window_idx<span class="op">].</span>timestamp <span class="op">=</span> hal_get_time_ms<span class="op">();</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>window_idx <span class="op">=</span> <span class="op">(</span>agg<span class="op">-&gt;</span>window_idx <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> SAMPLES_PER_WINDOW<span class="op">;</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update min/max/sum</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>agg<span class="op">-&gt;</span>count <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        agg<span class="op">-&gt;</span>min <span class="op">=</span> agg<span class="op">-&gt;</span>max <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sample <span class="op">&lt;</span> agg<span class="op">-&gt;</span>min<span class="op">)</span> agg<span class="op">-&gt;</span>min <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sample <span class="op">&gt;</span> agg<span class="op">-&gt;</span>max<span class="op">)</span> agg<span class="op">-&gt;</span>max <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>sum <span class="op">+=</span> sample<span class="op">;</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    agg<span class="op">-&gt;</span>count<span class="op">++;</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update histogram</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>    update_histogram<span class="op">(</span>agg<span class="op">,</span> sample<span class="op">);</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple ML inference: compute weighted sum</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> ml_inference<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> result <span class="op">=</span> ml_model<span class="op">.</span>bias<span class="op">;</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute features: min, avg, max for each sensor</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>        sensor_aggregator_t<span class="op">*</span> agg <span class="op">=</span> <span class="op">&amp;</span>aggregators<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> avg <span class="op">=</span> <span class="op">(</span>agg<span class="op">-&gt;</span>count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>agg<span class="op">-&gt;</span>sum <span class="op">/</span> agg<span class="op">-&gt;</span>count <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        ml_model<span class="op">.</span>features<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>agg<span class="op">-&gt;</span>min<span class="op">;</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>        ml_model<span class="op">.</span>features<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> avg<span class="op">;</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>        ml_model<span class="op">.</span>features<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>agg<span class="op">-&gt;</span>max<span class="op">;</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dot product with weights</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS <span class="op">*</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>        result <span class="op">+=</span> ml_model<span class="op">.</span>weights<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> ml_model<span class="op">.</span>features<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a><span class="co">// Data aggregation and processing main task</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> aggregation_task<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize ML model with random weights (demonstration)</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> MODEL_WEIGHTS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>        ml_model<span class="op">.</span>weights<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="er">.1f</span><span class="op">;</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>    ml_model<span class="op">.</span>bias <span class="op">=</span> <span class="dv">0</span><span class="er">.5f</span><span class="op">;</span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read all sensors</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> raw <span class="op">=</span> hal_adc_read<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int16_t</span> sample <span class="op">=</span> <span class="op">(</span><span class="dt">int16_t</span><span class="op">)</span>raw<span class="op">;</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>            update_statistics<span class="op">(&amp;</span>aggregators<span class="op">[</span>i<span class="op">],</span> sample<span class="op">);</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>        iteration_count<span class="op">++;</span></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Every 256 samples (~once per minute at 4Hz), perform ML inference</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>iteration_count <span class="op">%</span> <span class="dv">256</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>            <span class="dt">float</span> inference_result <span class="op">=</span> ml_inference<span class="op">();</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transmit aggregated statistics + inference result</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint8_t</span> packet<span class="op">[</span><span class="dv">128</span><span class="op">];</span></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint16_t</span> offset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Pack sensor statistics</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>                sensor_aggregator_t<span class="op">*</span> agg <span class="op">=</span> <span class="op">&amp;</span>aggregators<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Min (2B)</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>                <span class="op">*(</span><span class="dt">int16_t</span><span class="op">*)(</span>packet <span class="op">+</span> offset<span class="op">)</span> <span class="op">=</span> agg<span class="op">-&gt;</span>min<span class="op">;</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Max (2B)</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>                <span class="op">*(</span><span class="dt">int16_t</span><span class="op">*)(</span>packet <span class="op">+</span> offset<span class="op">)</span> <span class="op">=</span> agg<span class="op">-&gt;</span>max<span class="op">;</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Avg (2B)</span></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int16_t</span> avg <span class="op">=</span> <span class="op">(</span>agg<span class="op">-&gt;</span>count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> agg<span class="op">-&gt;</span>sum <span class="op">/</span> agg<span class="op">-&gt;</span>count <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>                <span class="op">*(</span><span class="dt">int16_t</span><span class="op">*)(</span>packet <span class="op">+</span> offset<span class="op">)</span> <span class="op">=</span> avg<span class="op">;</span></span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ML inference result (4B)</span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>            <span class="op">*(</span><span class="dt">float</span><span class="op">*)(</span>packet <span class="op">+</span> offset<span class="op">)</span> <span class="op">=</span> inference_result<span class="op">;</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">+=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Histogram (peak bin only, 1B)</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint16_t</span> peak_bin <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint16_t</span> peak_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> HISTOGRAM_BINS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>aggregators<span class="op">[</span><span class="dv">0</span><span class="op">].</span>histogram<span class="op">[</span>i<span class="op">]</span> <span class="op">&gt;</span> peak_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>                    peak_count <span class="op">=</span> aggregators<span class="op">[</span><span class="dv">0</span><span class="op">].</span>histogram<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>                    peak_bin <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>            packet<span class="op">[</span>offset<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">uint8_t</span><span class="op">)</span>peak_bin<span class="op">;</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Iteration counter (4B)</span></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>            <span class="op">*(</span><span class="dt">uint32_t</span><span class="op">*)(</span>packet <span class="op">+</span> offset<span class="op">)</span> <span class="op">=</span> iteration_count<span class="op">;</span></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">+=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>            hal_tx_send<span class="op">(</span>packet<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Reset statistics for next window</span></span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_SENSORS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>                aggregators<span class="op">[</span>i<span class="op">].</span>sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>                aggregators<span class="op">[</span>i<span class="op">].</span>count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>        ch_send<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// Yield to other coroutines</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>aggregators<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>aggregators<span class="op">));</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(&amp;</span>ml_model<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ml_model<span class="op">));</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>    iteration_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>    aggregation_task<span class="op">();</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>RAM 構成 (128KB Guest Heap: 48KB):</strong> - wasi-libc:
~1-2KB (最小化ビルド) - 静的構造体 (sensor_aggregator_t × 3): - 3
sensors × (128 samples × 4B + 32 histogram × 2B + metadata 16B) ≈ 4.5KB
- ML モデルデータ (ml_model_t): - 64 weights × 4B + bias 4B + 9 features
× 4B ≈ 308B - 動作用ヒープ: ~4-8KB (临时バッファ、ローカル変数) -
<strong>合計: ~10-15KB / 48KB</strong> ← 33KB
余力で追加モデルやバッファ可能</p>
<p><strong>サービスプラグイン例（複数 ML パイプライン）:</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service_plugin_ml_preprocessing.c: Advanced sensor preprocessing</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> hal_adc_read<span class="op">(</span><span class="dt">int</span> channel<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> ch_send<span class="op">(</span><span class="dt">int</span> ch_id<span class="op">,</span> <span class="dt">int</span> value<span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> ch_recv<span class="op">(</span><span class="dt">int</span> ch_id<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> value<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PREPROCESS_BUFFER_SIZE </span><span class="dv">512</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_FILTERS </span><span class="dv">3</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> alpha<span class="op">;</span>  <span class="co">// IIR coefficient</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> prev<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> iir_filter_t<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>iir_filter_t filters<span class="op">[</span>NUM_FILTERS<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="dt">uint16_t</span> preprocess_buf<span class="op">[</span>PREPROCESS_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="dt">uint16_t</span> buf_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> preprocess_service<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize IIR filters with different cutoff frequencies</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    filters<span class="op">[</span><span class="dv">0</span><span class="op">].</span>alpha <span class="op">=</span> <span class="dv">0</span><span class="er">.1f</span><span class="op">;</span>   <span class="co">// Low-pass 1</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    filters<span class="op">[</span><span class="dv">1</span><span class="op">].</span>alpha <span class="op">=</span> <span class="dv">0</span><span class="er">.3f</span><span class="op">;</span>   <span class="co">// Low-pass 2</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    filters<span class="op">[</span><span class="dv">2</span><span class="op">].</span>alpha <span class="op">=</span> <span class="dv">0</span><span class="er">.5f</span><span class="op">;</span>   <span class="co">// Low-pass 3</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read raw sensor</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> raw <span class="op">=</span> hal_adc_read<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int16_t</span> sample <span class="op">=</span> <span class="op">(</span><span class="dt">int16_t</span><span class="op">)</span>raw<span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply cascading IIR filters for noise reduction</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> filtered <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>sample<span class="op">;</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_FILTERS<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">[</span>i<span class="op">].</span>prev <span class="op">=</span> filters<span class="op">[</span>i<span class="op">].</span>alpha <span class="op">*</span> filtered</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>                            <span class="op">+</span> <span class="op">(</span><span class="fl">1.0</span><span class="bu">f</span> <span class="op">-</span> filters<span class="op">[</span>i<span class="op">].</span>alpha<span class="op">)</span> <span class="op">*</span> filters<span class="op">[</span>i<span class="op">].</span>prev<span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>            filtered <span class="op">=</span> filters<span class="op">[</span>i<span class="op">].</span>prev<span class="op">;</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store preprocessed value</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        preprocess_buf<span class="op">[</span>buf_idx<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">uint16_t</span><span class="op">)</span>filtered<span class="op">;</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>buf_idx <span class="op">&gt;=</span> PREPROCESS_BUFFER_SIZE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>            buf_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Notify guest app of new preprocessed sample</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        ch_send<span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>filtered<span class="op">);</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>RAM 構成 (Service Heap: 4KB):</strong> - IIR フィルタ状態:
~36B - プリプロセッシングバッファ: ~1KB - 動作用ヒープ: ~1KB -
<strong>合計: ~2-3KB / 4KB</strong> ← 1-2KB 利用可能</p>
<p>用途例（Guest）： - Time-series analysis + histogram (5-10KB) - ML
model weights + inference (8-15KB) - Real-time statistics computation
(3-5KB) - Free: ~25-32KB (追加モデルやロギング用)</p>
<p>用途例（Services）： - Signal preprocessing (IIR/FIR filters: 2-3KB)
- Complex sensor fusion (Kalman filtering: 2-4KB) - Message
routing/transformation (1-2KB)</p>
<h3 id="メモリレイアウト例memory-layout-example">1.3
メモリレイアウト例（Memory Layout Example）</h3>
<p><strong>6 分割配置の重要な原則：</strong> 1. <strong>Partition
1-2（COOS Kernel）</strong>: 固定割り当て、絶対に失敗しない 2.
<strong>Partition 3（Subsystems）</strong>: logger, hal
ネイティブ実装、システム機能の一部 3. <strong>Partition
4（Services）</strong>: ユーザー提供 WASM
プラグイン、<strong>独立隔離</strong> ← 新規分離 4. <strong>Coroutine
Stacks</strong>: 各スタックは 4-8KB、物理的に分離 5. <strong>Partition
5（Guest Heap）</strong>: ゲストモジュール、完全独立 6.
<strong>Partition 6（Reserve）</strong>: 通常は未使用、緊急回復用</p>
<p><strong>障害隔離の利点：</strong> - P3 枯渇（Subsystem） →
ログが出ない ⚠️ だが、制御は継続 - P4 枯渇（Service） →
そのサービスのみ終了 ✓ 他は全て継続 - P5 枯渇（Guest） → ゲストのみ終了
✓ システム・サービスは継続</p>
<h4 id="実装時の初期化フロー6分割メモリシステム"><strong>1.2.4
実装時の初期化フロー（6分割メモリシステム）</strong></h4>
<div class="sourceCode" id="cb14"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: システム起動時の RAM 初期化（6分割）</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_memory_system<span class="op">(</span><span class="dt">uint32_t</span> total_ram<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 1: COOS Kernel Heap（絶対に失敗しない）</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  mspace coos_heap <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">1536</span><span class="op">);</span>  <span class="co">// 1.5KB</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>coos_heap<span class="op">)</span> system_panic<span class="op">(</span><span class="st">&quot;COOS heap creation failed&quot;</span><span class="op">);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 2: WASM Runtime Heap（絶対に失敗しない）</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  mspace wasm_heap <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">4096</span><span class="op">);</span>  <span class="co">// 4KB</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>wasm_heap<span class="op">)</span> system_panic<span class="op">(</span><span class="st">&quot;WASM heap creation failed&quot;</span><span class="op">);</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 3: Subsystems Heap (router + logger + hal native implementation)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  mspace subsys_heap <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">4096</span><span class="op">);</span>  <span class="co">// 4KB</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 枯渇 → router, logger, hal に ERROR イベント、IPC 停止</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 4: Services Heap (user WASM service plugins)</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  mspace services_heap <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">4096</span><span class="op">);</span>  <span class="co">// 4KB</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 枯渇 → terminate_service()、他は全て継続</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coroutine Stack Pool (each 4-8KB, physically isolated)</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stack_total <span class="op">=</span> MAX_COROS <span class="op">*</span> STACK_SIZE<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span><span class="op">*</span> stack_pool <span class="op">=</span> <span class="op">(</span><span class="dt">uint8_t</span><span class="op">*)</span>malloc<span class="op">(</span>stack_total<span class="op">);</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>stack_pool<span class="op">)</span> system_panic<span class="op">(</span><span class="st">&quot;Stack pool allocation failed&quot;</span><span class="op">);</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 5: Guest Module Heap (remaining)</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> guest_heap_size <span class="op">=</span> total_ram</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="op">(</span><span class="dv">1536</span> <span class="op">+</span> <span class="dv">4096</span> <span class="op">+</span> <span class="dv">4096</span> <span class="op">+</span> <span class="dv">4096</span><span class="op">)</span>  <span class="co">// P1+P2+P3+P4</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> stack_total</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="dv">2560</span><span class="op">;</span>  <span class="co">// Reserve</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  mspace guest_heap <span class="op">=</span> create_mspace<span class="op">(</span>guest_heap_size<span class="op">);</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 枯渇 → unload_guest_module()、System は全て継続</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Partition 6: System Reserve (never used)</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  mspace reserve_heap <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">2560</span><span class="op">);</span>  <span class="co">// 2.5KB</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Register all mspaces in registry</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_COOS<span class="op">,</span> coos_heap<span class="op">);</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_WASM<span class="op">,</span> wasm_heap<span class="op">);</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_SUBSYSTEMS<span class="op">,</span> subsys_heap<span class="op">);</span>  <span class="co">// ← 新規</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_SERVICES<span class="op">,</span> services_heap<span class="op">);</span>  <span class="co">// ← 新規分離</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_GUEST<span class="op">,</span> guest_heap<span class="op">);</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  register_mspace<span class="op">(</span>PARTITION_RESERVE<span class="op">,</span> reserve_heap<span class="op">);</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: コンポーネント毎の割り当て</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_coos_kernel<span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// co_sched: Ready queue, metadata</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> scheduler <span class="op">=</span> mspace_malloc<span class="op">(</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    get_mspace<span class="op">(</span>PARTITION_COOS<span class="op">),</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> co_sched<span class="op">)</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// co_csp: Channel structures, wait queues</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> channel_pool <span class="op">=</span> mspace_malloc<span class="op">(</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    get_mspace<span class="op">(</span>PARTITION_COOS<span class="op">),</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> channel<span class="op">)</span> <span class="op">*</span> MAX_CHANNELS</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">// co_mem: dlmalloc wrapper state</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> mem_state <span class="op">=</span> mspace_malloc<span class="op">(</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    get_mspace<span class="op">(</span>PARTITION_COOS<span class="op">),</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> co_mem_state<span class="op">)</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 2: WASM Runtime 初期化</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_wasm_runtime<span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Interpreter state (per guest module)</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> interp <span class="op">=</span> mspace_malloc<span class="op">(</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    get_mspace<span class="op">(</span>PARTITION_WASM<span class="op">),</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> wasm_interpreter<span class="op">)</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Module loader state</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> loader <span class="op">=</span> mspace_malloc<span class="op">(</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    get_mspace<span class="op">(</span>PARTITION_WASM<span class="op">),</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> wasm_module_loader<span class="op">)</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: Subsystems 初期化（Partition 3）</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_subsystems<span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  mspace subsys_heap <span class="op">=</span> get_mspace<span class="op">(</span>PARTITION_SUBSYSTEMS<span class="op">);</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// logger: ring buffer (256 events)</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> ring_buf <span class="op">=</span> mspace_malloc<span class="op">(</span>subsys_heap<span class="op">,</span> <span class="dv">256</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>logger_event<span class="op">));</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>ring_buf<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Subsystems heap exhausted: logger ring buffer failed&quot;</span><span class="op">);</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 制御は継続、logger-&gt;error() は別途ハンドリング</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">// hal: device registry (max 16 devices)</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">*</span> dev_registry <span class="op">=</span> mspace_malloc<span class="op">(</span>subsys_heap<span class="op">,</span> <span class="dv">16</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>hal_device<span class="op">));</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>dev_registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Subsystems heap exhausted: hal registry failed&quot;</span><span class="op">);</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 制御は継続、hal routines は別途フォールバック</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: Services 初期化（Partition 4 - ユーザー WASM プラグイン）</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_services<span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Services heap is prepared but empty initially</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Service plugins are loaded dynamically:</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Custom sensor driver (WASM)</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Message router (WASM)</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - etc.</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a><span class="co">// Service プラグイン読み込み</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> load_service_plugin<span class="op">(</span><span class="at">const</span> <span class="dt">uint8_t</span><span class="op">*</span> wasm_binary<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>  mspace services_heap <span class="op">=</span> get_mspace<span class="op">(</span>PARTITION_SERVICES<span class="op">);</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>  wasm_module<span class="op">*</span> svc_mod <span class="op">=</span> wasm_loader<span class="op">-&gt;</span>load<span class="op">(</span>wasm_binary<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>svc_mod<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Failed to load service plugin&quot;</span><span class="op">);</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Load failure</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Service 専用の mspace を作成</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>  mspace svc_space <span class="op">=</span> create_mspace_from_heap<span class="op">(</span>services_heap<span class="op">,</span> MAX_SERVICE_ALLOC<span class="op">);</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>svc_space<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Services heap exhausted: cannot allocate plugin space&quot;</span><span class="op">);</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    wasm_loader<span class="op">-&gt;</span>unload<span class="op">(</span>svc_mod<span class="op">);</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Cannot load due to heap exhaustion</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>  register_module_heap<span class="op">(</span>svc_mod<span class="op">-&gt;</span>id<span class="op">,</span> svc_space<span class="op">);</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svc_mod<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Load guest module (Phase 2)</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> load_guest_module<span class="op">(</span><span class="at">const</span> <span class="dt">uint8_t</span><span class="op">*</span> wasm_binary<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Module loader uses PARTITION_WASM</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>  wasm_module<span class="op">*</span> mod <span class="op">=</span> wasm_loader<span class="op">-&gt;</span>load<span class="op">(</span>wasm_binary<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Module&#39;s dlmalloc mspace (Partition 4)</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>  mspace guest_space <span class="op">=</span> create_mspace<span class="op">(</span>guest_heap_remaining<span class="op">());</span></span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>  register_module_heap<span class="op">(</span>mod<span class="op">-&gt;</span>id<span class="op">,</span> guest_space<span class="op">);</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Module can now allocate from guest_space via dlmalloc</span></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mod<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="スケーリング計算式6分割"><strong>1.2.5
スケーリング計算式（6分割）</strong></h4>
<p>実装時に各パーティションサイズを調整する場合、以下の計算式を使用してください：</p>
<p><strong>基本パラメータ：</strong></p>
<pre><code>N_coro = 現在のコルーチン数（デフォルト: 8）
N_chan = 同時チャネル数（デフォルト: 16）
N_dev  = ハードウェアデバイス数（デフォルト: 16）
N_svc  = ユーザーサービスプラグイン数（デフォルト: 0-2）</code></pre>
<p><strong>Partition 1 (COOS Kernel) - 固定：</strong></p>
<pre><code>P1_size = 320B              // co_sched base
        + (N_chan × 128B)   // co_csp channels + wait queues
        + 512B              // co_mem metadata
        + 512B              // co_value ownership registry
        + 256B              // margins
        = 512B + (N_chan × 128B)

例：N_chan = 16
P1_size = 512B + (16 × 128B) = 2.5KB → 推奨 1.5KB (余裕確保)</code></pre>
<p><strong>Partition 2 (WASM Runtime) - 固定：</strong></p>
<pre><code>P2_size = 512B              // Interpreter base
        + (256 × 4B)        // Value stack
        + (64 × 4B)         // Local variables buffer
        + 512B              // Module loader state
        + 256B              // Margins
        = 2.5KB (fixed) → 推奨 4KB (十分な余裕)</code></pre>
<p><strong>Partition 3 (Subsystems) スケーリング -
ネイティブのみ：</strong></p>
<pre><code>P3_size = (256 × 8B)        // logger ring buffer
        + 512B              // logger queue nodes
        + (N_dev × 48B)     // hal device registry
        + 512B              // hal state + routing
        = 3.3KB + (N_dev × 48B)

例：N_dev = 16
P3_size = 3.3KB + (16 × 48B) = 4.1KB → 推奨 4.0KB (十分な余裕)

重要: Subsystems は絶対に fail しないようにしっかり余裕を持つ</code></pre>
<p><strong>Partition 4 (Services) スケーリング - WASM
プラグインのみ：</strong></p>
<pre><code>P4_size = N_svc × MAX_SERVICE_SIZE  // サービスプラグイン用
        + 1024B                     // Service registry + routing

デフォルト（N_svc = 0, 動的読み込み）:
P4_size = 4KB (初期状態)

サービスプラグイン追加時:
P4_size = max(4KB, N_svc × 2KB) → 推奨 8KB

例：2 個の service plugin（各 2KB）
P4_size = 2 × 2KB + 1KB = 5KB → 推奨 8KB</code></pre>
<p><strong>Partition 5 (Guest Heap) - 残余計算：</strong></p>
<pre><code>Total_RAM = デバイスの利用可能 RAM
Stack_Total = N_coro × STACK_SIZE

P5_size = Total_RAM - (P1 + P2 + P3 + P4 + P6) - Stack_Total

例：64KB システム、8 coroutines × 4KB
P5_size = 64KB - (1.5KB + 4KB + 4KB + 4KB + 2.5KB) - 32KB = 16KB ✓</code></pre>
<p><strong>実装で選択すべき設定：</strong></p>
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 12%" />
<col style="width: 10%" />
<col style="width: 7%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 15%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr class="header">
<th>RAM</th>
<th>N_coro</th>
<th>STACK</th>
<th>P1</th>
<th>P2</th>
<th>P3(Sub)</th>
<th>P4(Svc)</th>
<th>P6(Res)</th>
<th>P5(Guest)</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>32KB</td>
<td>4</td>
<td>2KB</td>
<td>1.5KB</td>
<td>4KB</td>
<td>4KB</td>
<td>4KB</td>
<td>2.5KB</td>
<td>8.0KB</td>
<td>最小 IoT</td>
</tr>
<tr class="even">
<td>64KB</td>
<td>8</td>
<td>4KB</td>
<td>1.5KB</td>
<td>4KB</td>
<td>4KB</td>
<td>4KB</td>
<td>2.5KB</td>
<td>16.0KB</td>
<td>標準 IoT</td>
</tr>
<tr class="odd">
<td>128KB</td>
<td>16</td>
<td>4KB</td>
<td>1.5KB</td>
<td>4KB</td>
<td>4KB</td>
<td>4KB</td>
<td>2.5KB</td>
<td>48.0KB</td>
<td>エッジ</td>
</tr>
<tr class="even">
<td>256KB+</td>
<td>32+</td>
<td>8KB</td>
<td>1.5KB</td>
<td>4KB</td>
<td>4KB</td>
<td>8KB</td>
<td>2.5KB</td>
<td>残余</td>
<td>高性能</td>
</tr>
</tbody>
</table>
<p><strong>選択基準：</strong> - <strong>P3(Subsystems)</strong>:
システム可用性が第一、十分な余裕を確保 - <strong>P4(Services)</strong>:
ユーザーサービス個数に応じて動的配分 - <strong>P5(Guest)</strong>:
残余を全てゲスト用に割り当て</p>
<h4 id="メモリ監視と診断6分割"><strong>1.2.6
メモリ監視と診断（6分割）</strong></h4>
<p>Phase 2
以降、以下の監視メカニズムを実装してください。各パーティションの失敗時の動作が異なります：</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// メモリ使用率の監視</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> partition_id<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">;</span>          <span class="co">// &quot;COOS&quot;, &quot;WASM&quot;, &quot;Subsystems&quot;, &quot;Services&quot;, &quot;Guest&quot;, &quot;Reserve&quot;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> allocated<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> peak<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> total_size<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> utilization_percent<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> is_critical<span class="op">;</span>          <span class="co">// P1-P2=true（システムパニック時）</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">memory_usage_t</span><span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: デバッグ表示</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_memory_stats<span class="op">()</span> <span class="op">{</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> partition_names<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;COOS&quot;</span><span class="op">,</span> <span class="st">&quot;WASM&quot;</span><span class="op">,</span> <span class="st">&quot;Subsystems&quot;</span><span class="op">,</span> <span class="st">&quot;Services&quot;</span><span class="op">,</span> <span class="st">&quot;Guest&quot;</span><span class="op">,</span> <span class="st">&quot;Reserve&quot;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> p <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> p <span class="op">&lt;=</span> <span class="dv">6</span><span class="op">;</span> p<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> stats <span class="op">=</span> get_partition_stats<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">-&gt;</span>info<span class="op">(</span><span class="st">&quot;P</span><span class="sc">%d</span><span class="st">(</span><span class="sc">%s</span><span class="st">): </span><span class="sc">%d</span><span class="st">/</span><span class="sc">%d</span><span class="st">B (</span><span class="sc">%.1f%%</span><span class="st"> used, peak </span><span class="sc">%d</span><span class="st">B) </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>      p<span class="op">,</span> partition_names<span class="op">[</span>p<span class="op">],</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>      stats<span class="op">.</span>allocated<span class="op">,</span> stats<span class="op">.</span>total_size<span class="op">,</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="dt">float</span><span class="op">)</span>stats<span class="op">.</span>allocated <span class="op">/</span> stats<span class="op">.</span>total_size <span class="op">*</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      stats<span class="op">.</span>peak<span class="op">,</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      stats<span class="op">.</span>utilization_percent <span class="op">&gt;</span> <span class="dv">90</span> <span class="op">?</span> <span class="st">&quot;⚠️ WARNING&quot;</span> <span class="op">:</span> <span class="st">&quot;&quot;</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 1: 枯渇検知（パーティション毎の異なる動作）</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> on_allocation_failure<span class="op">(</span>partition_id p<span class="op">,</span> <span class="dt">size_t</span> requested<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> available <span class="op">=</span> get_available_space<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;PARTITION_</span><span class="sc">%d</span><span class="st"> EXHAUSTED: requested </span><span class="sc">%d</span><span class="st">B, available </span><span class="sc">%d</span><span class="st">B&quot;</span><span class="op">,</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    p<span class="op">,</span> requested<span class="op">,</span> available</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_COOS<span class="op">:</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_WASM<span class="op">:</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 致命的: システムパニック</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;FATAL: COOS/WASM heap exhaustion → System Reset&quot;</span><span class="op">);</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>      system_reset<span class="op">();</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_SUBSYSTEMS<span class="op">:</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">// デバッグ喪失だが制御は継続</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;WARNING: Subsystems heap exhausted (logger/hal degraded)&quot;</span><span class="op">);</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">// logger は引き続き動作（既存バッファ使用）</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>      <span class="co">// hal は別途フォールバック処理</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_SERVICES<span class="op">:</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">// そのサービスのみ終了</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Service allocation failed: terminating service&quot;</span><span class="op">);</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>      terminate_service_by_heap<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 他のサービス・システムは全て継続</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_GUEST<span class="op">:</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ゲストモジュールのみ終了</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;Guest module exhausted: unloading guest&quot;</span><span class="op">);</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>      unload_guest_module<span class="op">();</span>  <span class="co">// P5 全体が解放される</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>      <span class="co">// System・Services は全て継続</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PARTITION_RESERVE<span class="op">:</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 予約領域は本来使用しない</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>error<span class="op">(</span><span class="st">&quot;CRITICAL: System Reserve used (should never happen)&quot;</span><span class="op">);</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>      system_reset<span class="op">();</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Phase 2: 詳細な統計収集</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>  partition_id id<span class="op">;</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> alloc_count<span class="op">;</span>        <span class="co">// 割り当て成功回数</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> free_count<span class="op">;</span>         <span class="co">// 解放回数</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> fail_count<span class="op">;</span>         <span class="co">// 割り当て失敗回数</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> fragmentation<span class="op">;</span>      <span class="co">// フラグメンテーション率（%）</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">partition_statistics_t</span><span class="op">;</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> collect_partition_stats<span class="op">()</span> <span class="op">{</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> p <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> p <span class="op">&lt;=</span> <span class="dv">6</span><span class="op">;</span> p<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> stats <span class="op">=</span> get_partition_stats<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>stats<span class="op">.</span>fail_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">-&gt;</span>warn<span class="op">(</span><span class="st">&quot;P</span><span class="sc">%d</span><span class="st"> failures: </span><span class="sc">%d</span><span class="st"> attempts failed&quot;</span><span class="op">,</span> p<span class="op">,</span> stats<span class="op">.</span>fail_count<span class="op">);</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>監視ルール：</strong> - <strong>P1-P2 (COOS/WASM)</strong>: ≥
80% 使用率で WARN ログ - <strong>P3 (Subsystems)</strong>: ≥ 70%
使用率で WARN ログ（重要度高） - <strong>P4 (Services)</strong>: ≥ 85%
使用率で INFO ログ（新規サービス読み込み前に確認） - <strong>P5
(Guest)</strong>: ≥ 90% 使用率で INFO
ログ（アプリケーション最適化のヒント）</p>
<hr />
<h2 id="コンテキストスイッチコストcontext-switch-cost">2.
コンテキストスイッチコスト（Context Switch Cost）</h2>
<h3 id="測定measurements">2.1 測定（Measurements）</h3>
<p>コルーチン間のコンテキストスイッチのコストを分析します。</p>
<p><strong>ARM Cortex-M4（STM32F4）での計測：</strong></p>
<pre><code>コンテキストスイッチシーケンス（協調的）:

1. yield() コール           ~5 cycles
2. レジスタセーブ          ~20 cycles（スタックメモリ）
3. Ready queue から取り出し ~10 cycles
4. レジスタリストア        ~20 cycles
5. 関数リターン             ~5 cycles
                         ─────────
合計                        ~60 cycles

システムクロック 100MHz の場合：
60 cycles / 100MHz = 600 nanoseconds ≈ 0.6μs

効率性：
- 1 コルーチン切り替え = 0.6μs
- 1000 回の切り替え = 0.6ms
- システムオーバーヘッド &lt; 1% （10ms イベントループの場合）</code></pre>
<h3 id="最適化戦略optimization-strategy">2.2 最適化戦略（Optimization
Strategy）</h3>
<p><strong>Ready queue 最適化：</strong></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 従来：リニアサーチ O(n)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">*</span> coro <span class="op">=</span> ready_queue<span class="op">.</span>head<span class="op">;</span> coro<span class="op">;</span> coro <span class="op">=</span> coro<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>coro<span class="op">-&gt;</span>id <span class="op">==</span> target_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... 処理</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 最適化：O(1) 直接アクセス</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>coroutine<span class="op">*</span> target <span class="op">=</span> ready_array<span class="op">[</span>target_id <span class="op">%</span> MAX_COROS<span class="op">];</span></span></code></pre></div>
<hr />
<h2 id="チャネル操作コストchannel-operation-cost">3.
チャネル操作コスト（Channel Operation Cost）</h2>
<h3 id="基本操作basic-operations">3.1 基本操作（Basic Operations）</h3>
<pre><code>チャネル send（ノンブロッキング、受信者待機中）:
1. 受信者チェック        ~10 cycles
2. 値をコピー           ~20 cycles（move の場合は ~5）
3. 受信者を Ready に    ~15 cycles
4. スケジューラー通知   ~5 cycles
                      ─────────
合計                    ~50 cycles（move の場合 ~30）

チャネル recv（ブロッキング、送信者待機中）:
1. 送信者チェック        ~10 cycles
2. 値をコピー           ~20 cycles（move の場合は ~5）
3. 送信者を Ready に    ~15 cycles
                      ─────────
合計                    ~45 cycles（move の場合 ~30）</code></pre>
<h3 id="move-セマンティクスの効果move-semantics-impact">3.2 move
セマンティクスの効果（Move Semantics Impact）</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 従来のコピー（メモリ割り当て発生）</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>co_value<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> msg <span class="op">=</span> co_value<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span><span class="st">&quot;Hello&quot;</span><span class="op">);</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>channel<span class="op">-&gt;</span>send<span class="op">(</span>msg<span class="op">);</span>  <span class="co">// ~50 cycles + メモリコピー</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">// move セマンティクス（コピーなし）</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>co_value<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> msg <span class="op">=</span> co_value<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span><span class="st">&quot;Hello&quot;</span><span class="op">);</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>channel<span class="op">-&gt;</span>send<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>msg<span class="op">));</span>  <span class="co">// ~30 cycles（メモリ操作なし）</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 改善効果：</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">// - 大規模データ（1MB）: 33% 高速化（メモリコピー削減）</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">// - 小規模データ（&lt;1KB）: 20-30% 高速化（メタデータ処理）</span></span></code></pre></div>
<hr />
<h2 id="メモリ隔離のパフォーマンスmemory-isolation-performance">4.
メモリ隔離のパフォーマンス（Memory Isolation Performance）</h2>
<h3 id="dlmalloc-mspace-オーバーヘッド">4.1 dlmalloc mspace
オーバーヘッド</h3>
<div class="sourceCode" id="cb26"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// グローバルヒープ（従来）</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span><span class="op">*</span> ptr <span class="op">=</span> malloc<span class="op">(</span><span class="dv">1024</span><span class="op">);</span>  <span class="co">// 1 つのヒープ全体を走査</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">// mspace（モジュール隔離）</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>mspace space <span class="op">=</span> create_mspace<span class="op">(</span><span class="dv">8192</span><span class="op">);</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span><span class="op">*</span> ptr <span class="op">=</span> mspace_malloc<span class="op">(</span>space<span class="op">,</span> <span class="dv">1024</span><span class="op">);</span>  <span class="co">// mspace 内のみ走査</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">// パフォーマンス比較：</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">// - グローバルヒープ: O(n) フラグメンテーション</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">// - mspace 隔離: O(m)、m は 1 つのモジュールサイズ</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 効果：10 モジュールで約 90% 割り当て高速化</span></span></code></pre></div>
<h3 id="メモリ枯渇時の動作memory-exhaustion-behavior">4.2
メモリ枯渇時の動作（Memory Exhaustion Behavior）</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Module A が枯渇</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>mspace_malloc<span class="op">(</span>space_A<span class="op">,</span> size<span class="op">)</span> → <span class="kw">nullptr</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>→ logger に ERROR イベント送信</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>→ モジュール A を terminate</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>→ Module B・C は継続実行</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">// 効果：</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">// - モジュール隔離により、1 つの失敗が波及しない</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">// - システム全体の可用性維持</span></span></code></pre></div>
<hr />
<h2 id="メモリレイアウト最適化memory-layout-optimization">5.
メモリレイアウト最適化（Memory Layout Optimization）</h2>
<h3 id="wasm-線形メモリ配置">5.1 WASM 線形メモリ配置</h3>
<pre><code>┌─────────────────────────────────────┐
│ WASM Module Linear Memory           │
├─────────────────────────────────────┤
│ Code (RO)           [ 4KB-64KB ]    │ Interpreter cache
├─────────────────────────────────────┤
│ Data Section (RW)   [ 1KB-16KB ]    │ Global variables
├─────────────────────────────────────┤
│ Heap (RW)           [ remaining ]   │ Runtime allocation
│ (managed by dlmalloc mspace)        │
│                                     │
└─────────────────────────────────────┘

最適化ポイント：
- Code セクション: ページ境界に配置
- Data セクション: アライメント 8 バイト
- Heap: コンパクション機構不要（mspace）</code></pre>
<h3 id="アライメント戦略alignment-strategy">5.2
アライメント戦略（Alignment Strategy）</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 構造体のパディング最小化</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="ex">__attribute__((packed))</span> <span class="op">{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> id<span class="op">;</span>           <span class="co">// 4B</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> state<span class="op">;</span>        <span class="co">// 2B</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> priority<span class="op">;</span>      <span class="co">// 1B</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> padding<span class="op">;</span>       <span class="co">// 1B （ワード境界）</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stack_ptr<span class="op">;</span>    <span class="co">// 4B</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Total: 12B （パディング最小）</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">coroutine_context_t</span><span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 効果：</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">// - 従来の構造体: 16B（3B パディング）</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">// - 最適化後: 12B（25% 削減）</span></span></code></pre></div>
<hr />
<h2 id="cpu-効率最適化cpu-efficiency-optimization">6. CPU
効率最適化（CPU Efficiency Optimization）</h2>
<h3 id="インタプリタループ最適化">6.1 インタプリタループ最適化</h3>
<div class="sourceCode" id="cb30"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// インタプリタメインループ（標準）</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  opcode <span class="op">=</span> <span class="op">*</span>pc<span class="op">++;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>opcode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> OP_I32_ADD<span class="op">:</span> <span class="op">...</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> OP_I32_SUB<span class="op">:</span> <span class="op">...</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 最適化：テーブル駆動ディスパッチ</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>handler_fn<span class="op">)(</span>interpreter_state<span class="op">&amp;);</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> handler_fn opcode_table<span class="op">[</span><span class="dv">256</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  handle_i32_add<span class="op">,</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  handle_i32_sub<span class="op">,</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  opcode <span class="op">=</span> <span class="op">*</span>pc<span class="op">++;</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  opcode_table<span class="op">[</span>opcode<span class="op">](*</span><span class="kw">this</span><span class="op">);</span>  <span class="co">// 直接分岐、分岐予測失敗なし</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co">// 改善効果：</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co">// - 分岐予測失敗削減: ~50% 減</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co">// - CPU キャッシュ効率: ~30% 向上</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co">// - スループット: ~20% 向上</span></span></code></pre></div>
<h3 id="タイムスライス設計timeslice-design">6.2
タイムスライス設計（Timeslice Design）</h3>
<p>Fireball は、ラウンドロビンスケジューラーと自動 yield
により、完全に公平なコルーチン実行を実現します。適切なタイムスライスは、<strong>リアルタイム性</strong>と
<strong>CPU 利用率</strong>のトレードオフを考慮して決定します。</p>
<p><strong>設計パラメータ：</strong></p>
<pre><code>リスト（Liste）: コルーチンが yield しなければならない最大時間
  - 目標: 300μs
  - 理由: センサー読み取り、イベント応答などで一般的な要件

デッドライン（Deadline）: システム全体のリアルタイム要件
  - 目標: 1ms
  - 理由: IoT・組み込みシステムの典型的なリアルタイム要件（1-10ms）</code></pre>
<p><strong>Reference Targets - CPU クロック別の計算：</strong></p>
<p>Fireball は以下の 3 つのリファレンスターゲットで検証されます：</p>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 21%" />
<col style="width: 23%" />
<col style="width: 16%" />
<col style="width: 11%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="header">
<th>CPU</th>
<th>クロック</th>
<th>1000 命令</th>
<th>300μs</th>
<th>1ms</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Cortex-M33</strong></td>
<td><strong>100MHz</strong></td>
<td><strong>10μs</strong></td>
<td><strong>30000命令</strong></td>
<td><strong>100000命令</strong></td>
<td><strong>IoT・組み込み</strong></td>
</tr>
<tr class="even">
<td><strong>RK3399</strong></td>
<td><strong>2GHz</strong></td>
<td><strong>0.5μs</strong></td>
<td><strong>600000命令</strong></td>
<td><strong>2000000命令</strong></td>
<td><strong>エッジ・高性能</strong></td>
</tr>
<tr class="odd">
<td><strong>Ryzen5 5600</strong></td>
<td><strong>3.5GHz</strong></td>
<td><strong>0.286μs</strong></td>
<td><strong>1050000命令</strong></td>
<td><strong>3500000命令</strong></td>
<td><strong>デスクトップ・検証</strong></td>
</tr>
</tbody>
</table>
<p><strong>計算方法：</strong></p>
<pre><code>YIELD_INTERVAL(CPU) = 30000 × (CPU_MHz / 100)

例：RK3399 @ 2000MHz
YIELD_INTERVAL = 30000 × (2000 / 100) = 600,000 命令</code></pre>
<p><strong>推奨設定：Cortex-M33（100MHz）-
IoT・組み込みメインストリーム</strong></p>
<p>Cortex-M33 は TrustZone-M
セキュリティ機能を備えており、IoT・組み込みシステムのメインストリーム
CPU となっています。</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ターゲット: 300μs のリスト</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">// → 30000 命令ごとの自動 yield</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define YIELD_INTERVAL </span><span class="dv">30000</span><span class="pp">  </span><span class="co">// 命令数（Cortex-M33 @ 100MHz）</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">// パフォーマンス分析：</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">// - yield コスト: ~60 cycles = 0.6μs</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">// - 30000 命令: ~300,000 cycles = 3ms（平均 CPI ≈ 1.0）</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">// - yield オーバーヘッド: 0.02%（無視できる）</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 応答性：</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">// - タイムスライス: 300μs（タイムアウト容認度）</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">// - 最悪ケース: 1 コルーチンが 300μs 実行 → 他のコルーチンは最大 300μs 待機</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">// - N コルーチン時の応答時間: 最大 300μs × N</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">// TrustZone-M 環境での注意：</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co">// - Secure World / Non-Secure World 間の遷移時間を考慮</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">// - セキュアエンクレーブ内での yield は別途設計が必要な場合あり</span></span></code></pre></div>
<p><strong>RK3399（2GHz）- エッジ・高性能用:</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define YIELD_INTERVAL </span><span class="dv">600000</span><span class="pp">  </span><span class="co">// 命令数（RK3399 @ 2GHz）</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">// 同じ 300μs のリスト性能を維持</span></span></code></pre></div>
<p><strong>Ryzen5 5600（3.5GHz）- デスクトップ検証用:</strong></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define YIELD_INTERVAL </span><span class="dv">1050000</span><span class="pp">  </span><span class="co">// 命令数（Ryzen5 5600 @ 3.5GHz）</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">// 同じ 300μs のリスト性能を維持</span></span></code></pre></div>
<p><strong>N コルーチン環境での応答時間：</strong></p>
<table>
<thead>
<tr class="header">
<th>コルーチン数</th>
<th>最悪ケース応答時間</th>
<th>適用例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>300μs</td>
<td>シングルタスク（制御系）</td>
</tr>
<tr class="even">
<td>2</td>
<td>600μs</td>
<td>デュアルタスク（センサ + 制御）</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1.2ms</td>
<td>複数センサ（温度、湿度、気圧、加速度）</td>
</tr>
<tr class="even">
<td>8</td>
<td>2.4ms</td>
<td>複雑なシステム（制限あり）</td>
</tr>
</tbody>
</table>
<p><strong>組み込みシステムの実例から：</strong></p>
<ul>
<li><strong>300μs リスト</strong>: 一般的な組み込みシステムの許容値
<ul>
<li>ADC サンプリング（10-50kHz）: 20-100μs 周期</li>
<li>PWM 制御（1-20kHz）: 50-1000μs 周期</li>
<li>CAN bus イベント: 1-10ms</li>
</ul></li>
<li><strong>1ms デッドライン</strong>: ハードウェア割り込み周期の典型値
<ul>
<li>タイマー割り込み: 1ms（1kHz）</li>
<li>高速制御ループ: 1-10ms</li>
</ul></li>
</ul>
<p><strong>実装コード例：</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WASM インタプリタのメインループ</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> wasm_interpreter <span class="op">{</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">private</span><span class="op">:</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> <span class="va">instruction_count_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">uint32_t</span> YIELD_INTERVAL <span class="op">=</span> <span class="dv">30000</span><span class="op">;</span>  <span class="co">// 300μs @ 100MHz</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> execute_instruction<span class="op">(</span><span class="at">const</span> wasm_instruction<span class="op">&amp;</span> instr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... 命令実行</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">instruction_count_</span><span class="op">++;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="va">instruction_count_</span> <span class="op">%</span> YIELD_INTERVAL <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>      co_csp<span class="op">::</span>yield<span class="op">();</span>  <span class="co">// コンテキストスイッチ</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">instruction_count_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// カウンタリセット</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>リアルタイム性の検証方法：</strong></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">// コルーチン応答時間計測</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> response_time_monitor <span class="op">{</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> max_wait_time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// μs</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> total_yield_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> on_yield<span class="op">()</span> <span class="op">{</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 他のコルーチンがいくつ待機しているか数える</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> waiting <span class="op">=</span> scheduler<span class="op">-&gt;</span>get_ready_queue_size<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> worst_case <span class="op">=</span> waiting <span class="op">*</span> <span class="dv">300</span><span class="op">;</span>  <span class="co">// μs</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    max_wait_time <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>max_wait_time<span class="op">,</span> worst_case<span class="op">);</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<hr />
<h2 id="バイナリサイズ最適化binary-size-optimization">7.
バイナリサイズ最適化（Binary Size Optimization）</h2>
<h3 id="コンパイルフラグ">7.1 コンパイルフラグ</h3>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># リリースビルド</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-O2</span> <span class="at">-flto</span> <span class="at">-ffunction-sections</span> <span class="at">-fdata-sections</span> <span class="dt">\</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">-Wl,--gc-sections</span> <span class="at">-Wl,--strip-all</span> <span class="dt">\</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">-std</span><span class="op">=</span>c++23 src/<span class="pp">*</span>.cpp <span class="at">-o</span> fireball.elf</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># サイズ削減：</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - O2 + LTO: ~30% 削減</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - function-sections: ~15% 削減</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># - gc-sections: ~10% 削減</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># - strip: ~5% 削減</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 合計: ~50% バイナリサイズ削減</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> arm-none-eabi-size fireball.elf</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">text</span>     data    bss    dec    hex filename</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">28124</span>      512   1024  29660   73fc fireball.elf</span></code></pre></div>
<h3 id="テンプレート最適化">7.2 テンプレート最適化</h3>
<div class="sourceCode" id="cb39"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 問題：テンプレートはインスタンス化ごとにコード生成</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> co_value <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  T value<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... 実装</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>co_value<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> v1<span class="op">;</span>      <span class="co">// T=int でインスタンス化</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>co_value<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> v2<span class="op">;</span>    <span class="co">// T=float でインスタンス化</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>co_value<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> v3<span class="op">;</span>   <span class="co">// T=double でインスタンス化</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 結果：3 つの異なるコードが生成される</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co">// 解決策：void 特殊化</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;&gt;</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> co_value<span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span> <span class="co">/* 汎用実装 */</span> <span class="op">};</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co">// 効果：</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co">// - 本体サイズ: 8KB → 2KB（75% 削減）</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co">// - 実行時オーバーヘッド: 型チェック ~5 cycles</span></span></code></pre></div>
<hr />
<h2 id="プロファイリングprofiling">8. プロファイリング（Profiling）</h2>
<h3 id="cpu-プロファイリング">8.1 CPU プロファイリング</h3>
<div class="sourceCode" id="cb40"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CPU 使用率計測</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> instruction_count<span class="op">;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> cycle_count<span class="op">;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> context_switches<span class="op">;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> channel_operations<span class="op">;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">performance_counter_t</span><span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> log_performance<span class="op">()</span> <span class="op">{</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> cpu <span class="op">=</span> get_performance_counter<span class="op">();</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Instructions: &quot;</span> <span class="op">&lt;&lt;</span> cpu<span class="op">.</span>instruction_count <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;IPC: &quot;</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>cpu<span class="op">.</span>instruction_count <span class="op">/</span> cpu<span class="op">.</span>cycle_count <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Context switches: &quot;</span> <span class="op">&lt;&lt;</span> cpu<span class="op">.</span>context_switches <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Channel ops: &quot;</span> <span class="op">&lt;&lt;</span> cpu<span class="op">.</span>channel_operations <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="メモリプロファイリング">8.2 メモリプロファイリング</h3>
<div class="sourceCode" id="cb41"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// メモリ使用率計測</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> total_allocated<span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> peak_allocated<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size_t</span> fragmentation_ratio<span class="op">;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> allocation_failures<span class="op">;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">memory_stats_t</span><span class="op">;</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="dt">memory_stats_t</span> get_module_stats<span class="op">(</span><span class="dt">uint32_t</span> module_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> space <span class="op">=</span> get_module_mspace<span class="op">(</span>module_id<span class="op">);</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">{</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>total_allocated <span class="op">=</span> mspace_usable_size<span class="op">(</span>space<span class="op">),</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>peak_allocated <span class="op">=</span> mspace_peak_allocated<span class="op">(</span>space<span class="op">),</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>fragmentation_ratio <span class="op">=</span> mspace_fragmentation<span class="op">(</span>space<span class="op">),</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>allocation_failures <span class="op">=</span> mspace_failed_count<span class="op">(</span>space<span class="op">)</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="最適化チェックリストoptimization-checklist">9.
最適化チェックリスト（Optimization Checklist）</h2>
<p>デバイス移植時に確認すべき項目：</p>
<p><strong>基本チェック:</strong> - [ ] ROM 予算 &lt; 64KB - [ ] RAM
予算確認（デバイスの available memory） - [ ] コンテキストスイッチ &lt;
100 cycles - [ ] チャネル操作 &lt; 50 cycles - [ ]
メモリフラグメンテーション &lt; 20% - [ ] CPU 使用率 &lt; 50% （10ms
時点での計測） - [ ] バイナリサイズ計測（arm-none-eabi-size） - [ ]
メモリレイアウト検証（map ファイル）</p>
<p><strong>タイムスライス設定チェック（Phase 2 WASM
ランタイム実装時）:</strong></p>
<p>Reference Targets での検証： - [ ] Cortex-M33（100MHz）:
<code>YIELD_INTERVAL = 30000</code> - [ ] TrustZone-M
の遷移時間を測定（Secure/Non-Secure 境界） - [ ] RK3399（2GHz）:
<code>YIELD_INTERVAL = 600000</code> - [ ] マルチコア環境での動作確認 -
[ ] Ryzen5 5600（3.5GHz）: <code>YIELD_INTERVAL = 1050000</code> - [ ]
デスクトップ/高速 CPU での検証</p>
<p>共通検証： - [ ] リアルタイム性検証：300μs リスト、1ms deadline 達成
- [ ] 複数コルーチン環境でラウンドロビン動作確認 - [ ]
コンテキストスイッチイベントを logger subsystem で記録</p>
<hr />
<h2 id="ベンチマーク結果benchmark-results">10.
ベンチマーク結果（Benchmark Results）</h2>
<h3
id="reference-implementationcortex-m33100mhz---メインストリーム">10.1
Reference Implementation（Cortex-M33、100MHz - メインストリーム）</h3>
<p>Cortex-M33 は TrustZone-M セキュリティ機能を備えた
IoT・組み込みシステムのメインストリーム CPU です。以下のベンチマーク値は
Cortex-M33 @ 100MHz を基準としています。</p>
<pre><code>┌──────────────────────────────────────────┐
│  Fireball Benchmark Results              │
│  (Cortex-M33 @ 100MHz)                   │
├──────────────────────────────────────────┤
│ Context Switch:        0.6 μs ( 60 cycles)
│ Channel Send:          0.5 μs ( 50 cycles)
│ Channel Recv:          0.45 μs ( 45 cycles)
│ Memory Alloc (8B):     2.0 μs (200 cycles)
│ Memory Free:           1.0 μs (100 cycles)
│ WASM Add Instruction:  2.0 μs (200 cycles)
│ Automatic Yield:       0.6 μs ( 60 cycles)
├──────────────────────────────────────────┤
│ Total ROM (Phase 1):   28 KB
│ Total RAM (minimal):   2 KB
│ System Throughput:     500k cps (coroutine ops/sec)
│ Timeslice Response:    300 μs (1 coro) - 2.4 ms (8 coros)
└──────────────────────────────────────────┘</code></pre>
<h3 id="reference-targets-での予想パフォーマンス">10.2 Reference Targets
での予想パフォーマンス</h3>
<table style="width:100%;">
<colgroup>
<col style="width: 10%" />
<col style="width: 18%" />
<col style="width: 16%" />
<col style="width: 18%" />
<col style="width: 26%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="header">
<th>CPU</th>
<th>クロック</th>
<th>環境例</th>
<th>スケール</th>
<th>YIELD_INTERVAL</th>
<th>応答時間（4 coro）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Cortex-M33</strong></td>
<td><strong>100MHz</strong></td>
<td><strong>IoT・組み込み</strong></td>
<td><strong>1.0×</strong></td>
<td><strong>30,000</strong></td>
<td><strong>1.2ms</strong></td>
</tr>
<tr class="even">
<td><strong>RK3399</strong></td>
<td><strong>2GHz</strong></td>
<td><strong>エッジ・高性能</strong></td>
<td><strong>20×</strong></td>
<td><strong>600,000</strong></td>
<td><strong>1.2ms</strong></td>
</tr>
<tr class="odd">
<td><strong>Ryzen5 5600</strong></td>
<td><strong>3.5GHz</strong></td>
<td><strong>デスクトップ・検証</strong></td>
<td><strong>35×</strong></td>
<td><strong>1,050,000</strong></td>
<td><strong>1.2ms</strong></td>
</tr>
</tbody>
</table>
<p><strong>注記:</strong> YIELD_INTERVAL は CPU
クロックに比例しますが、タイムスライス（300μs
リスト）は全プラットフォームで一定に保たれます。</p>
<hr />
<h2 id="他のランタイムとの比較runtime-comparison">11.
他のランタイムとの比較（Runtime Comparison）</h2>
<h3 id="スペック比較表specification-comparison">11.1
スペック比較表（Specification Comparison）</h3>
<p>組み込みシステム向けランタイム/インタプリタを、Fireball
と共に評価します。以下は一般的な実装例の代表値です。</p>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 24%" />
<col style="width: 16%" />
<col style="width: 15%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th><strong>Fireball</strong></th>
<th><strong>mruby</strong></th>
<th><strong>Lua</strong></th>
<th><strong>MicroPython</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>言語</strong></td>
<td>WASM (structured)</td>
<td>Ruby</td>
<td>Lua</td>
<td>Python subset</td>
</tr>
<tr class="even">
<td><strong>ROM (最小)</strong></td>
<td>28 KB</td>
<td>200 KB</td>
<td>100 KB</td>
<td>300+ KB</td>
</tr>
<tr class="odd">
<td><strong>ROM (推奨)</strong></td>
<td>64 KB</td>
<td>250 KB</td>
<td>150 KB</td>
<td>400+ KB</td>
</tr>
<tr class="even">
<td><strong>RAM (最小)</strong></td>
<td>32 KB</td>
<td>100 KB</td>
<td>50 KB</td>
<td>150 KB</td>
</tr>
<tr class="odd">
<td><strong>RAM (推奨)</strong></td>
<td>64 KB</td>
<td>150 KB</td>
<td>100 KB</td>
<td>256 KB</td>
</tr>
<tr class="even">
<td><strong>Startup Time</strong></td>
<td>&lt; 1 ms</td>
<td>10-20 ms</td>
<td>5-10 ms</td>
<td>50+ ms</td>
</tr>
<tr class="odd">
<td><strong>GC Model</strong></td>
<td>Manual/Move</td>
<td>Mark-sweep</td>
<td>Mark-sweep</td>
<td>Mark-sweep</td>
</tr>
<tr class="even">
<td><strong>Context Switch</strong></td>
<td>0.6 μs (60 cycles)</td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr class="odd">
<td><strong>Code Load</strong></td>
<td>~10 ms (WASM)</td>
<td>~50 ms</td>
<td>~20 ms</td>
<td>~100+ ms</td>
</tr>
<tr class="even">
<td><strong>Per-Task Overhead</strong></td>
<td>24 B</td>
<td>~500 B</td>
<td>~200 B</td>
<td>~1 KB</td>
</tr>
<tr class="odd">
<td><strong>多タスク対応</strong></td>
<td>✅ Native (COOS)</td>
<td>⚠️ Fibers (複雑)</td>
<td>⚠️ Coroutines (複雑)</td>
<td>✅ Native (with threads)</td>
</tr>
<tr class="even">
<td><strong>メモリ隔離</strong></td>
<td>✅ mspace</td>
<td>❌ Global heap</td>
<td>❌ Global heap</td>
<td>❌ Global heap</td>
</tr>
</tbody>
</table>
<p><strong>注記:</strong> - <strong>ROM/RAM</strong>:
デバイス実装例（STM32L476、8KB SRAM 対応）における最小/推奨値 -
<strong>Context Switch</strong>:
コルーチン間スイッチオーバーのレイテンシ - <strong>Per-Task
Overhead</strong>: 1 タスク追加時の RAM 消費量（スタック除き） -
<strong>多タスク対応</strong>: ネイティブサポート vs
外部ライブラリ依存の度合い</p>
<h3 id="デバイス容量別ランタイム選択ガイド">11.2
デバイス容量別ランタイム選択ガイド</h3>
<h4 id="kb-ram-マイクロコントローラー向け"><strong>&lt; 32 KB RAM:
マイクロコントローラー向け</strong></h4>
<table style="width:100%;">
<colgroup>
<col style="width: 42%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>デバイス例</th>
<th>推奨</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>STM32L072</strong> (8 KB SRAM)</td>
<td>❌ 全て不可</td>
<td>最小要件未達</td>
</tr>
<tr class="even">
<td><strong>STM32L476</strong> (96 KB SRAM)</td>
<td>🟢 <strong>Fireball</strong></td>
<td>32 KB 最小 + 余白 64 KB で快適</td>
</tr>
<tr class="odd">
<td><strong>nRF52840</strong> (256 KB SRAM)</td>
<td>🟢 <strong>Fireball</strong></td>
<td>最適；ただし mruby も可能（150 KB 必要）</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb43"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// STM32L476 (96 KB SRAM):</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Fireball: 32-64 KB + 32 KB guest → 良好</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// mruby:    150 KB → 超過（不可）</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Lua:      100 KB + overhead → ギリギリ</span></span></code></pre></div>
<h4 id="kb-ram-iot-エッジ向け"><strong>32-64 KB RAM: IoT
エッジ向け</strong></h4>
<table style="width:100%;">
<colgroup>
<col style="width: 42%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>デバイス例</th>
<th>推奨</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>nRF5240</strong> (96 KB SRAM)</td>
<td>🟢 <strong>Fireball</strong></td>
<td>最適；メモリ効率で圧倒</td>
</tr>
<tr class="even">
<td><strong>nRF5340</strong> (512 KB SRAM)</td>
<td>🟡 <strong>Fireball</strong> / mruby</td>
<td>Fireball は 28% 使用；mruby も可能</td>
</tr>
<tr class="odd">
<td><strong>RP2350</strong> (528 KB SRAM)</td>
<td>🟡 <strong>Fireball</strong> / Lua / mruby</td>
<td>全て選択肢；Fireball が最効率</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb44"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// nRF5240 (96 KB SRAM):</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Fireball: 64 KB + 32 KB guest → 最適</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">// mruby:    90 KB system → 6 KB 余裕のみ（不安定）</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Lua:      80 KB system → 16 KB 余裕（実用的）</span></span></code></pre></div>
<h4 id="kb-ram-アプリケーション層"><strong>64-128 KB RAM:
アプリケーション層</strong></h4>
<table style="width:100%;">
<colgroup>
<col style="width: 42%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>デバイス例</th>
<th>推奨</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>STM32H743</strong> (512 KB SRAM)</td>
<td>🟢 <strong>Lua / mruby / Fireball</strong></td>
<td>全て推奨；用途で選択</td>
</tr>
<tr class="even">
<td><strong>RK3399 Pro</strong> (1 GB SRAM)</td>
<td>🟢 <strong>MicroPython / mruby</strong></td>
<td>リッチ環境；MicroPython 本領</td>
</tr>
<tr class="odd">
<td><strong>Raspberry Pi 4</strong> (4 GB)</td>
<td>🟢 <strong>MicroPython</strong></td>
<td>標準選択</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb45"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// STM32H743 (512 KB SRAM):</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Fireball:    64 KB + 448 KB guest (可能だが過剰)</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Lua:         100 KB + 412 KB app code (推奨)</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">// mruby:       150 KB + 362 KB app code (推奨)</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">// MicroPython: 300+ KB + 200 KB余裕 (可能)</span></span></code></pre></div>
<h3 id="用途別推奨ランタイム">11.3 用途別推奨ランタイム</h3>
<h4
id="デバイス監視ロギングシンプル制御monitoring-logging-simple-control"><strong>デバイス監視・ロギング・シンプル制御（Monitoring,
Logging, Simple Control）</strong></h4>
<p><strong>Best Fit: Fireball</strong></p>
<pre class="wasm"><code>;; Fireball: ADC読み取り → ネットワーク送信（40 B code）
(func $read_adc_send
  (call $hal_adc_read (i32.const 0))
  (local.set $value)
  (call $ch_send (i32.const 0) (local.get $value))
)

;; コード: ~40 バイト WASM
;; メモリ: ~32 KB system + ~4 KB runtime</code></pre>
<div class="sourceCode" id="cb47"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mruby: ADC読み取り → ネットワーク送信（60行以上）</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">class</span> <span class="dt">SensorTask</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> initialize</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@adc</span> <span class="kw">=</span> <span class="cn">ADC</span><span class="at">.new</span>(<span class="wa">channel: </span><span class="dv">0</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@channel</span> <span class="kw">=</span> <span class="dt">Channel</span><span class="at">.new</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> run</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span> <span class="cf">do</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>      value <span class="kw">=</span> <span class="ot">@adc</span><span class="at">.read</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@channel</span><span class="at">.send</span>(value)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sleep</span>(<span class="dv">1</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co"># コード: ~60 バイト source</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># メモリ: ~150 KB system + ~50 KB runtime</span></span></code></pre></div>
<p><strong>Fireball の優位性</strong>: 5倍小さい ROM + 4倍小さい RAM</p>
<hr />
<h4
id="複雑なアルゴリズム機械学習iot-ゲートウェイcomplex-logic-ml-iot-gateway"><strong>複雑なアルゴリズム・機械学習・IoT
ゲートウェイ（Complex Logic, ML, IoT Gateway）</strong></h4>
<p><strong>Best Fit: Lua / mruby</strong></p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Lua: エッジ推論（TinyML 互換）</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">model</span> <span class="op">=</span> <span class="cn">ML</span><span class="op">.</span>load<span class="op">(</span><span class="st">&quot;model.tflite&quot;</span><span class="op">)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">sensors</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> process_sensor_data<span class="op">()</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">data</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span> <span class="cf">do</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table.insert</span><span class="op">(</span><span class="va">data</span><span class="op">,</span> read_sensor<span class="op">(</span><span class="va">i</span><span class="op">))</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">result</span> <span class="op">=</span> <span class="va">model</span><span class="op">:</span>infer<span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">result</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p><strong>Fireball での実装</strong>: WASM で同等ロジック →
数倍ハイレベル言語より複雑</p>
<hr />
<h4
id="デスクトップ高性能エッジプロトタイピングdesktophigh-performance-edge-prototyping"><strong>デスクトップ/高性能エッジ・プロトタイピング（Desktop/High-Performance
Edge, Prototyping）</strong></h4>
<p><strong>Best Fit: MicroPython</strong></p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MicroPython: フル Python 互換</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> machine</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    adc <span class="op">=</span> machine.ADC(machine.Pin(<span class="dv">32</span>))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    sock <span class="op">=</span> socket.socket()</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> adc.read()</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        sock.send(<span class="bu">str</span>(value).encode())</span></code></pre></div>
<p><strong>優位性</strong>: 開発速度、ライブラリ豊富、デバッグ容易</p>
<hr />
<h3 id="デバイス-goldilocks-zone-分析">11.4 デバイス “Goldilocks Zone”
分析</h3>
<p>各ランタイムが最適なメモリ容量範囲：</p>
<pre><code>  ROM (KB)
  500 │                        MicroPython
      │                        (300-500KB)
  400 │                    ┌───────────────┐
      │                    │  実用範囲     │
  300 │     mruby   ┌──────┴──────┐       │
      │     (200-250KB)  │   実用  │       │
  200 │          ┌────────┴──────┐│       │
      │          │    実用       ││       │
  100 │  Lua     │   (150KB)     ││       │
      │ (100-150) │              ││       │
      │┌─────────┴┐              ││       │
   50 ││Fireball  │              ││       │
      ││(28-64KB) │              ││       │
      │└──────────┴──────────────┴┴───────┘
    0 └─────────────────────────────────────→ RAM (KB)
        32        64        128       256
      ▲         ▲         ▲         ▲
   IoT-μ     IoT-L      Edge      Desktop</code></pre>
<p><strong>結論:</strong> - <strong>0-64 KB</strong>: Fireball
が唯一の実用的選択肢 - <strong>64-128 KB</strong>: Fireball（効率）/
Lua（柔軟）の二者択一 - <strong>128-256 KB</strong>: Lua / mruby /
MicroPython（平等） - <strong>256 KB+</strong>:
MicroPython（豊富なライブラリ）が標準</p>
<h3 id="詳細スペック分析">11.5 詳細スペック分析</h3>
<h4 id="rom-フットプリント詳細"><strong>11.5.1 ROM
フットプリント詳細</strong></h4>
<table>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>Fireball</th>
<th>mruby</th>
<th>Lua</th>
<th>MicroPython</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Core VM</strong></td>
<td>8 KB</td>
<td>80 KB</td>
<td>40 KB</td>
<td>150 KB</td>
</tr>
<tr class="even">
<td><strong>Builtins</strong></td>
<td>2 KB</td>
<td>60 KB</td>
<td>30 KB</td>
<td>100 KB</td>
</tr>
<tr class="odd">
<td><strong>Standard Library</strong></td>
<td>0 KB</td>
<td>40 KB</td>
<td>20 KB</td>
<td>50 KB</td>
</tr>
<tr class="even">
<td><strong>Optional Services</strong></td>
<td>20 KB</td>
<td>20 KB</td>
<td>10 KB</td>
<td>100 KB</td>
</tr>
<tr class="odd">
<td><strong>Total Min</strong></td>
<td><strong>28 KB</strong></td>
<td><strong>200 KB</strong></td>
<td><strong>100 KB</strong></td>
<td><strong>300 KB</strong></td>
</tr>
</tbody>
</table>
<p><strong>分析:</strong> - Fireball: 構造化 WASM 仕様により、VM が極小
- mruby: オブジェクトシステムのため肥大化 - Lua:
効率的設計だが、GC/メタテーブルでオーバーヘッド - MicroPython: CPython
互換性のため大規模</p>
<h4 id="起動時間boot-time"><strong>11.5.2 起動時間（Boot
Time）</strong></h4>
<table>
<thead>
<tr class="header">
<th>ランタイム</th>
<th>冷起動</th>
<th>ウォーム起動</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Fireball</strong></td>
<td>&lt; 1 ms</td>
<td>&lt; 0.5 ms</td>
<td>WASM バイナリ解析最小化</td>
</tr>
<tr class="even">
<td><strong>Lua</strong></td>
<td>5-10 ms</td>
<td>2-5 ms</td>
<td>テーブル初期化</td>
</tr>
<tr class="odd">
<td><strong>mruby</strong></td>
<td>10-20 ms</td>
<td>5-10 ms</td>
<td>オブジェクトシステム</td>
</tr>
<tr class="even">
<td><strong>MicroPython</strong></td>
<td>50+ ms</td>
<td>20-50 ms</td>
<td>フル Python 互換性</td>
</tr>
</tbody>
</table>
<p><strong>実務的影響:</strong> - <strong>Fireball</strong>:
リアルタイムシステムで 10-20 ms スリープ許容外 - <strong>Lua</strong>:
組み込み用途では実用的 - <strong>MicroPython</strong>:
デスクトップ開発では無視できる遅延</p>
<h4 id="gcガベージコレクションパフォーマンス"><strong>11.5.3
GC（ガベージコレクション）パフォーマンス</strong></h4>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 13%" />
<col style="width: 18%" />
<col style="width: 29%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="header">
<th>ランタイム</th>
<th>GC 方式</th>
<th>GC Latency</th>
<th>Predictability</th>
<th>メモリ効率</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Fireball</strong></td>
<td>Manual + Move</td>
<td>なし（リロケーション時）</td>
<td>予測可能</td>
<td>95%</td>
</tr>
<tr class="even">
<td><strong>Lua</strong></td>
<td>Mark-sweep</td>
<td>1-10 ms (GC cycle)</td>
<td>⚠️ 可変</td>
<td>85-90%</td>
</tr>
<tr class="odd">
<td><strong>mruby</strong></td>
<td>Mark-sweep</td>
<td>10-50 ms</td>
<td>⚠️ 可変</td>
<td>80-85%</td>
</tr>
<tr class="even">
<td><strong>MicroPython</strong></td>
<td>Mark-sweep</td>
<td>50+ ms</td>
<td>❌ 不確定</td>
<td>70-80%</td>
</tr>
</tbody>
</table>
<p><strong>リアルタイム含意:</strong> - <strong>Fireball</strong>: GC
pause なし → RT システム向け - <strong>Lua/mruby</strong>: GC pause
許容可能（IoT ロギング等） - <strong>MicroPython</strong>: GC pause
不確定 → 厳密 RT には不適</p>
<hr />
<h3 id="実装複雑度の比較">11.6 実装複雑度の比較</h3>
<h4
id="タスク例-リングバッファ内のセンサーデータ採集-送信"><strong>タスク例:
リングバッファ内のセンサーデータ採集 + 送信</strong></h4>
<p><strong>Fireball:</strong></p>
<pre class="wasm"><code>;; WASM: ~50 バイト
(func $sensor_loop
  (local $buf_idx i32)
  (local $value i32)
  (block $break
    (loop $continue
      ;; buf[idx % 256] = ADC_READ()
      (call $hal_adc_read (i32.const 0))
      (local.set $value)
      (call $buf_write (local.get $buf_idx) (local.get $value))

      ;; idx++
      (local.set $buf_idx (i32.add (local.get $buf_idx) (i32.const 1)))

      ;; 256 回でチャネル送信
      (if (i32.eq (i32.rem_u (local.get $buf_idx) (i32.const 256)) (i32.const 0))
        (then
          (call $ch_send (i32.const 0) (local.get $buf_idx))
        )
      )

      (br $continue)
    )
  )
)</code></pre>
<p><strong>Lua (mruby 同様):</strong></p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Lua: ~80 行</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">BUF_SIZE</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">buffer</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">idx</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> sensor_loop<span class="op">()</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="kw">true</span> <span class="cf">do</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ADC 読み取り</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">value</span> <span class="op">=</span> <span class="va">adc</span><span class="op">:</span><span class="fu">read</span><span class="op">()</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table.insert</span><span class="op">(</span><span class="va">buffer</span><span class="op">,</span> <span class="va">value</span><span class="op">)</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- 256 個バッファ→送信</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">#</span><span class="va">buffer</span> <span class="op">&gt;=</span> <span class="cn">BUF_SIZE</span> <span class="cf">then</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>      send_data<span class="op">(</span><span class="va">buffer</span><span class="op">)</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">buffer</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Yield to other coroutines</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coroutine.yield</span><span class="op">()</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p><strong>実装難度:</strong> - <strong>Fireball</strong>: 中（WASM
学習必須だが、構造明確） - <strong>Lua</strong>: 低（スクリプト記法） -
<strong>mruby</strong>: 低（Ruby 記法） - <strong>MicroPython</strong>:
低（Python 記法）</p>
<p><strong>開発時間（カジュアル開発者）:</strong> - Fireball: 30-60
分（WASM チュートリアル含） - Lua/mruby: 10-20 分 - MicroPython: 5-10
分</p>
<hr />
<h3 id="フットプリント分析サマリー">11.7 フットプリント分析サマリー</h3>
<h4
id="total-system-sizeruntime-典型的アプリケーション-os"><strong>Total
System Size（Runtime + 典型的アプリケーション + OS）</strong></h4>
<table style="width:100%;">
<colgroup>
<col style="width: 11%" />
<col style="width: 20%" />
<col style="width: 11%" />
<col style="width: 15%" />
<col style="width: 28%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="header">
<th>環境</th>
<th>Fireball</th>
<th>Lua</th>
<th>mruby</th>
<th>MicroPython</th>
<th>勝者</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>STM32L476</strong> (96 KB)</td>
<td>96 KB</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>🏆 Fireball</td>
</tr>
<tr class="even">
<td><strong>nRF5240</strong> (96 KB)</td>
<td>64 KB</td>
<td>80 KB</td>
<td>90 KB</td>
<td>-</td>
<td>🏆 Fireball</td>
</tr>
<tr class="odd">
<td><strong>STM32H745</strong> (512 KB)</td>
<td>150 KB</td>
<td>200 KB</td>
<td>250 KB</td>
<td>400+ KB</td>
<td>🏆 Fireball</td>
</tr>
<tr class="even">
<td><strong>RPI 4</strong> (1 GB)</td>
<td>N/A</td>
<td>-</td>
<td>-</td>
<td>500 KB</td>
<td>🏆 MicroPython</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="選択フローチャート">11.8 選択フローチャート</h3>
<pre><code>┌─ デバイス RAM 容量？
│
├─ &lt; 32 KB
│  └─→ &quot;Fireball のみ選択肢&quot; ✓
│
├─ 32-64 KB
│  └─→ &quot;Fireball（推奨） or Lua（柔軟性）&quot;
│
├─ 64-128 KB
│  └─→ &quot;Fireball / Lua / mruby（全て選択肢）&quot;
│      └─→ 言語好みで選択
│          ├─ Ruby好き → mruby
│          ├─ Lua好き → Lua
│          └─ 効率重視 → Fireball
│
├─ 128-256 KB
│  └─→ &quot;Lua / mruby / MicroPython（平等）&quot;
│      └─→ コミュニティ/ライブラリで選択
│
└─ &gt; 256 KB
   └─→ &quot;MicroPython（推奨）&quot;
       └─→ 豊富なライブラリ + 習いやすさ</code></pre>
<hr />
<h2 id="phase-1-2-実装時の性能確認">12. Phase 1 &amp; 2
実装時の性能確認</h2>
<ul class="task-list">
<li><label><input type="checkbox" />ROM サイズ計測：28KB
以下</label></li>
<li><label><input type="checkbox" />RAM 使用量：2KB
以下（スタック・ヒープ除外）</label></li>
<li><label><input type="checkbox" />コンテキストスイッチ時間：0.6μs
以下</label></li>
<li><label><input type="checkbox" />チャネル操作：0.5μs
以下</label></li>
<li><label><input type="checkbox" />メモリ割り当て：5μs
以下</label></li>
</ul>
<hr />
<h2 id="参考資料references">13. 参考資料（References）</h2>
<ul>
<li><strong>ARM Cortex-M Performance</strong>: ARM
DDI0403E_d_armv7m_arm.pdf</li>
<li><strong>dlmalloc</strong>:
http://g.oswego.edu/dl/html/malloc.html</li>
<li><strong>WASM Optimization</strong>: WebAssembly Design
Documents</li>
<li><strong>mruby</strong>: https://github.com/mruby/mruby</li>
<li><strong>Lua</strong>: https://www.lua.org/</li>
<li><strong>MicroPython</strong>: https://micropython.org/</li>
</ul>
<hr />
<h2 id="まとめsummary">まとめ（Summary）</h2>
<p>Fireball は、cooperative マルチタスキング、move
セマンティクス、メモリ隔離により、組み込みシステムの厳しいパフォーマンス要件を満たす設計です。</p>
<p>重要な最適化ポイント： 1. <strong>コンテキストスイッチ</strong>:
協調的だからこそ予測可能で高速 2. <strong>チャネル通信</strong>: move
で大規模データ転送のオーバーヘッド削減 3. <strong>メモリ隔離</strong>:
mspace で割り当て高速化と枯渇分離の両立</p>
<p>これらの設計選択により、リソース制約のある環境でも、複雑なマルチタスクシステムを効率的に実装できます。</p>
<hr />
<h2 id="sloc-ベース見積りsource-lines-of-code-estimation">12. SLOC
ベース見積り（Source Lines of Code Estimation）</h2>
<p>本セクションは、Fireball の各コンポーネント実装に必要な SLOC（Source
Lines of
Code）の見積りを提供します。これにより、開発リソース計画、実装工数見積り、コンポーネント間の複雑度比較が可能になります。</p>
<p><strong>SLOC 計算ルール：</strong> -
実装コード行数のみ（コメント、空行、ドキュメント文字列は除外） -
テストコードは含めない（別途テストカバレッジセクションで扱う） -
インラインドキュメント（<code>//</code>、<code>///</code>）は含める -
マクロ定義、型定義は含める</p>
<h3 id="コンポーネント別-sloc-見積り">12.1 コンポーネント別 SLOC
見積り</h3>
<h4 id="phase-0-コア最小実装sloc-総計-800-1000"><strong>Phase 0:
コア最小実装（SLOC 総計: ~800-1000）</strong></h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>SLOC</th>
<th>依存</th>
<th>難度</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>COOS Core</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>co_sched (scheduler)</td>
<td>200-250</td>
<td>なし</td>
<td>中</td>
<td>Ready queue、yield、resume 実装</td>
</tr>
<tr class="odd">
<td>co_csp (channels)</td>
<td>150-200</td>
<td>co_sched</td>
<td>中</td>
<td>Send/Recv、buffer 管理</td>
</tr>
<tr class="even">
<td>co_mem (memory)</td>
<td>80-120</td>
<td>なし</td>
<td>低</td>
<td>dlmalloc wrapper、mspace 管理</td>
</tr>
<tr class="odd">
<td>co_value (ownership)</td>
<td>100-150</td>
<td>なし</td>
<td>高</td>
<td>Ownership registry、move validation</td>
</tr>
<tr class="even">
<td><strong>Subtotal</strong></td>
<td><strong>530-720</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Platform Layer</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>hal_backend (stub)</td>
<td>50-100</td>
<td>なし</td>
<td>低</td>
<td>GPIO/I2C/SPI stub、platform依存</td>
</tr>
<tr class="even">
<td>main.cpp (startup)</td>
<td>40-60</td>
<td>全</td>
<td>低</td>
<td>初期化シーケンス</td>
</tr>
<tr class="odd">
<td><strong>Subtotal</strong></td>
<td><strong>90-160</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Phase 0 Total</strong></td>
<td><strong>620-880</strong></td>
<td></td>
<td></td>
<td>PoC 段階、最小機能のみ</td>
</tr>
</tbody>
</table>
<h4 id="phase-1-wasm-interpreter-最小版sloc-追加-600-900"><strong>Phase
1: WASM Interpreter 最小版（SLOC 追加: ~600-900）</strong></h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>SLOC</th>
<th>依存</th>
<th>難度</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>vSoC Runtime</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>interpreter (i32 core)</td>
<td>400-600</td>
<td>co_sched</td>
<td>高</td>
<td>45個命令ディスパッチ、スタック管理</td>
</tr>
<tr class="odd">
<td>module_loader</td>
<td>80-150</td>
<td>なし</td>
<td>中</td>
<td>WASM バイナリ解析、セクション抽出</td>
</tr>
<tr class="even">
<td>vsoc_impl</td>
<td>120-150</td>
<td>上記全</td>
<td>中</td>
<td>Runtime initialization、builtin functions</td>
</tr>
<tr class="odd">
<td><strong>Subtotal</strong></td>
<td><strong>600-900</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Phase 1 Total</strong></td>
<td><strong>1220-1780</strong></td>
<td>Phase 0</td>
<td></td>
<td>Interpreter 実行可能</td>
</tr>
</tbody>
</table>
<h4 id="phase-2-型付きkey-value形式-ipcsloc-追加-400-600"><strong>Phase
2: 型付きKey-Value形式 IPC（SLOC 追加: ~400-600）</strong></h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>SLOC</th>
<th>依存</th>
<th>難度</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Subsystems</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>ipc_router</td>
<td>200-300</td>
<td>co_sched, co_csp</td>
<td>高</td>
<td>URI routing、dispatch、access control</td>
</tr>
<tr class="odd">
<td>logger (subsystem)</td>
<td>80-120</td>
<td>ipc_router</td>
<td>低</td>
<td>Ring buffer、event logging</td>
</tr>
<tr class="even">
<td>keyval (codec)</td>
<td>120-180</td>
<td>なし</td>
<td>中</td>
<td>Encode/Decode、type handling</td>
</tr>
<tr class="odd">
<td><strong>Subtotal</strong></td>
<td><strong>400-600</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Phase 2 Total</strong></td>
<td><strong>1620-2380</strong></td>
<td>Phase 1</td>
<td></td>
<td>Router IPC 機能</td>
</tr>
</tbody>
</table>
<h4 id="phase-3-hal-debuggersloc-追加-500-800"><strong>Phase 3: HAL +
Debugger（SLOC 追加: ~500-800）</strong></h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>SLOC</th>
<th>依存</th>
<th>難度</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Runtime-Embedded</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>gpio_embedded</td>
<td>40-60</td>
<td>hal_backend</td>
<td>低</td>
<td>GPIO read/write (直接呼び出し)</td>
</tr>
<tr class="odd">
<td>offloader_embedded</td>
<td>80-120</td>
<td>mmio, ipc_router</td>
<td>中</td>
<td>GPU dispatch、sys_read/write routing</td>
</tr>
<tr class="even">
<td>debugger_embedded</td>
<td>60-100</td>
<td>なし</td>
<td>中</td>
<td>GDB protocol stub、breakpoint管理</td>
</tr>
<tr class="odd">
<td><strong>Subsystems</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>hal (subsystem)</td>
<td>150-220</td>
<td>GPIO、I2C、SPI backend</td>
<td>中</td>
<td>Device registry、routing table、ADC IPC</td>
</tr>
<tr class="odd">
<td>debugger (service)</td>
<td>120-180</td>
<td>debugger_embedded</td>
<td>中</td>
<td>Session管理、command parsing</td>
</tr>
<tr class="even">
<td><strong>Subtotal</strong></td>
<td><strong>450-680</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Phase 3 Total</strong></td>
<td><strong>2070-3060</strong></td>
<td>Phase 2</td>
<td></td>
<td>Debugger + embedded functions</td>
</tr>
</tbody>
</table>
<h4 id="phase-4-jit-compilersloc-追加-1200-2000"><strong>Phase 4: JIT
Compiler（SLOC 追加: ~1200-2000）</strong></h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>SLOC</th>
<th>依存</th>
<th>難度</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>JIT Core</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>hotpath_detector</td>
<td>150-250</td>
<td>co_sched</td>
<td>中</td>
<td>Loop counter、call frequency tracking</td>
</tr>
<tr class="odd">
<td>jit_compiler</td>
<td>600-1000</td>
<td>interpreter</td>
<td>高</td>
<td>Code generation、register allocation</td>
</tr>
<tr class="even">
<td>backend (ARM Thumb)</td>
<td>300-600</td>
<td>jit_compiler</td>
<td>高</td>
<td>Architecture-specific codegen</td>
</tr>
<tr class="odd">
<td><strong>Subtotal</strong></td>
<td><strong>1050-1850</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>JIT Background Executor</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>jit_scheduler</td>
<td>100-150</td>
<td>co_sched</td>
<td>中</td>
<td>Low-latency compilation scheduling</td>
</tr>
<tr class="odd">
<td><strong>Subtotal</strong></td>
<td><strong>100-150</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Phase 4 Total</strong></td>
<td><strong>3170-5010</strong></td>
<td>Phase 3</td>
<td></td>
<td>完全 JIT 実装</td>
</tr>
</tbody>
</table>
<h3 id="依存関係と実装順序">12.2 依存関係と実装順序</h3>
<pre><code>Phase 0 (Core)
  ├─ co_sched ────────┐
  ├─ co_csp ◄────────┘
  ├─ co_mem
  ├─ co_value
  └─ hal_backend (stub)

Phase 1 (Interpreter)
  ├─ interpreter ◄─── co_sched
  ├─ module_loader
  └─ vsoc_impl ◄────── interpreter

Phase 2 (Router IPC)
  ├─ ipc_router ◄───── co_sched + co_csp
  ├─ logger ◄──────── ipc_router
  └─ keyval (独立)

Phase 3 (HAL + Debugger)
  ├─ gpio_embedded ◄─ hal_backend
  ├─ offloader_embedded ◄─ ipc_router
  ├─ debugger_embedded
  ├─ hal (subsystem) ◄─ GPIO/I2C/SPI/ADC (IPC)
  └─ debugger (service) ◄─ debugger_embedded

Phase 4 (JIT - Optional)
  ├─ hotpath_detector ◄─ co_sched
  ├─ jit_compiler ◄─── interpreter
  ├─ backend (ARM Thumb)
  └─ jit_scheduler ◄─ co_sched</code></pre>
<h3 id="パフォーマンスとコンプライアンス">12.3
パフォーマンスとコンプライアンス</h3>
<p><strong>SLOC vs ROM/RAM 関係：</strong></p>
<table>
<thead>
<tr class="header">
<th>段階</th>
<th>SLOC</th>
<th>ROM予想</th>
<th>RAM予想</th>
<th>実行可能</th>
<th>最適化レベル</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Phase 0</td>
<td>620-880</td>
<td>5-7KB</td>
<td>3.7KB</td>
<td>最小</td>
<td>-Os</td>
</tr>
<tr class="even">
<td>Phase 1</td>
<td>1220-1780</td>
<td>12-18KB</td>
<td>5.8KB</td>
<td>i32実行</td>
<td>-Os</td>
</tr>
<tr class="odd">
<td>Phase 2</td>
<td>1620-2380</td>
<td>18-28KB</td>
<td>12.0KB</td>
<td>IPC通信</td>
<td>-Os</td>
</tr>
<tr class="even">
<td>Phase 3</td>
<td>2070-3060</td>
<td>28-40KB</td>
<td>13.2KB</td>
<td>DebugHAL</td>
<td>-Os</td>
</tr>
<tr class="odd">
<td>Phase 4</td>
<td>3170-5010</td>
<td>40-60KB</td>
<td>16.5KB</td>
<td>Full JIT</td>
<td>-O2</td>
</tr>
</tbody>
</table>
<p><strong>予測 ROM サイズ（隠れたコスト含む）：</strong> - Phase 0:
8-10KB - Phase 1: 16-22KB - Phase 2: 22-35KB - Phase 3: 35-50KB - Phase
4: 50-75KB（要検証）</p>
<h3 id="sloc-ベース工数見積り">12.4 SLOC ベース工数見積り</h3>
<p><strong>仮定：</strong> - 1 SLOC = 0.5 分（一般的な組み込み C++） -
コード レビュー・テスト = SLOC × 0.3 倍 - ドキュメント・統合テスト =
SLOC × 0.2 倍</p>
<p><strong>Phase ごと開発時間（人日）：</strong></p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 13%" />
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 21%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="header">
<th>Phase</th>
<th>SLOC</th>
<th>コーディング</th>
<th>レビュー・テスト</th>
<th>統合・ドキュ</th>
<th>計</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Phase 0</td>
<td>750</td>
<td>6h</td>
<td>2.5h</td>
<td>2.5h</td>
<td>11h (1.5日)</td>
</tr>
<tr class="even">
<td>Phase 1</td>
<td>900</td>
<td>7.5h</td>
<td>3h</td>
<td>3h</td>
<td>13.5h (1.7日)</td>
</tr>
<tr class="odd">
<td>Phase 2</td>
<td>660</td>
<td>5.5h</td>
<td>2.2h</td>
<td>2.2h</td>
<td>10h (1.25日)</td>
</tr>
<tr class="even">
<td>Phase 3</td>
<td>990</td>
<td>8.25h</td>
<td>3.3h</td>
<td>3.3h</td>
<td>15h (1.9日)</td>
</tr>
<tr class="odd">
<td>Phase 4</td>
<td>1900</td>
<td>15.8h</td>
<td>6.3h</td>
<td>6.3h</td>
<td>28.5h (3.6日)</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td><strong>5200</strong></td>
<td><strong>43h</strong></td>
<td><strong>17.3h</strong></td>
<td><strong>17.3h</strong></td>
<td><strong>77.6h (10日)</strong></td>
</tr>
</tbody>
</table>
<p><strong>備考：</strong> - 上記は 1 人開発者換算 -
チーム開発の場合、平行度に応じて短縮可能 - PoC (Phase 0-2) = 3.5 日、MVP
(Phase 3) = 5 日相当 - Phase 4 (JIT)
は複雑度が高いため時間要因大きい</p>
<h3 id="コンポーネント複雑度指標">12.5 コンポーネント複雑度指標</h3>
<p><strong>McCabe サイクロマティック複雑度（推定）:</strong></p>
<table>
<thead>
<tr class="header">
<th>コンポーネント</th>
<th>推定 CC</th>
<th>複雑度レベル</th>
<th>高リスク関数</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>co_sched</td>
<td>8-12</td>
<td>中</td>
<td>yield(), resume()</td>
</tr>
<tr class="even">
<td>interpreter</td>
<td>25-35</td>
<td>高</td>
<td>dispatch_instruction()</td>
</tr>
<tr class="odd">
<td>ipc_router</td>
<td>15-20</td>
<td>高</td>
<td>route_message()</td>
</tr>
<tr class="even">
<td>jit_compiler</td>
<td>40-60</td>
<td>非常に高</td>
<td>codegen(), register_alloc()</td>
</tr>
<tr class="odd">
<td>offloader_embedded</td>
<td>12-16</td>
<td>中</td>
<td>sys_read/write() routing</td>
</tr>
</tbody>
</table>
<p><strong>テスト戦略：</strong> - CC &gt; 20 の関数は単体テスト必須 -
interpreter の各命令は独立テスト - ipc_router は境界値テスト必須</p>
<h3 id="技術的負債保守性指標">12.6 技術的負債・保守性指標</h3>
<p><strong>予測メトリクス：</strong></p>
<table>
<thead>
<tr class="header">
<th>指標</th>
<th>現在 (Phase 0)</th>
<th>Phase 3</th>
<th>Phase 4</th>
<th>目標</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Avg 関数行数</strong></td>
<td>15-20</td>
<td>20-30</td>
<td>25-40</td>
<td>&lt;30</td>
</tr>
<tr class="even">
<td><strong>Coupling</strong> (低い=良い)</td>
<td>低</td>
<td>中</td>
<td>中-高</td>
<td>低-中</td>
</tr>
<tr class="odd">
<td><strong>Cohesion</strong> (高い=良い)</td>
<td>高</td>
<td>高</td>
<td>中</td>
<td>高</td>
</tr>
<tr class="even">
<td><strong>コード重複度</strong></td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>&lt;3%</td>
</tr>
</tbody>
</table>
<hr />
</body>
</html>
